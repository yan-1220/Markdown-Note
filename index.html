<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Note Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- Markmap Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-lib"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-view"></script>
    <!-- Dexie.js for IndexedDB -->
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.js"></script>
    <style>
        /* 纯黑色背景主题 */
        body { background-color: #000000 !important; }
        .bg-gray-900 { background-color: #000000 !important; }
        .bg-gray-800 { background-color: #0a0a0a !important; }
        .bg-gray-700 { background-color: #1a1a1a !important; }
        .border-gray-700 { border-color: #2a2a2a !important; }
        .border-gray-600 { border-color: #333333 !important; }

        .note-list-item { transition: background-color 0.2s; }
        .note-list-item:hover { background-color: rgba(59, 130, 246, 0.25); }
        .note-list-item.active { background-color: rgba(59, 130, 246, 0.35); border-left: 4px solid #3b82f6; }
        .markdown-preview {
            line-height: 1.6;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', 'Microsoft YaHei', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: #9ca3af;
        }
        .markdown-preview h1 { font-size: 2em; font-weight: 900; margin: 0.67em 0; color: #ffffff; border-bottom: 2px solid #2a2a2a; padding-bottom: 0.3em; text-shadow: 0 0 10px rgba(255, 255, 255, 0.3); }
        .markdown-preview h2 { font-size: 1.5em; font-weight: 900; margin: 0.83em 0; color: #ffffff; border-bottom: 1px solid #2a2a2a; padding-bottom: 0.3em; text-shadow: 0 0 8px rgba(255, 255, 255, 0.25); }
        .markdown-preview h3 { font-size: 1.17em; font-weight: 800; margin: 1em 0; color: #ffffff; text-shadow: 0 0 6px rgba(255, 255, 255, 0.2); }
        .markdown-preview h4 { font-size: 1em; font-weight: 700; margin: 1em 0; color: #d1d5db; }
        .markdown-preview h5 { font-size: 0.875em; font-weight: 700; margin: 1em 0; color: #d1d5db; }
        .markdown-preview h6 { font-size: 0.85em; font-weight: 700; margin: 1em 0; color: #9ca3af; }
        .markdown-preview p { margin-bottom: 1em; color: #9ca3af; }
        .markdown-preview ul { list-style-type: disc; margin-left: 2em; margin-bottom: 1em; padding-left: 0; }
        .markdown-preview ol { list-style-type: decimal; margin-left: 2em; margin-bottom: 1em; padding-left: 0; }
        .markdown-preview li { margin-left: 1em; margin-bottom: 0.5em; }
        .markdown-preview code { background-color: #1a1a1a; color: #e5e7eb; padding: 0.2em 0.4em; border-radius: 3px; font-family: monospace; border: 1px solid #2a2a2a; }
        .markdown-preview pre { background-color: #0a0a0a; padding: 1em; border-radius: 5px; overflow-x: auto; margin-bottom: 1em; border: 1px solid #2a2a2a; }
        .markdown-preview pre code { background-color: transparent; padding: 0; border: none; }
        .markdown-preview blockquote { border-left: 4px solid #3b82f6; padding-left: 1em; margin: 0 0 1em 0; color: #6b7280; background-color: #0a0a0a; padding: 1em; border-radius: 3px; }
        .markdown-preview table { border-collapse: collapse; width: 100%; margin-bottom: 1em; }
        .markdown-preview table th { background-color: #1a1a1a; color: #ffffff; font-weight: bold; padding: 0.75em; text-align: left; border: 1px solid #2a2a2a; }
        .markdown-preview table td { padding: 0.75em; border: 1px solid #2a2a2a; }
        .markdown-preview table tr:nth-child(even) { background-color: #0a0a0a; }
        .markdown-preview table tr:hover { background-color: rgba(59, 130, 246, 0.15); }
        .markdown-preview a { color: #60a5fa; text-decoration: underline; }
        .markdown-preview a:hover { color: #93c5fd; }
        .markdown-preview hr { border: none; border-top: 1px solid #4b5563; margin: 1.5em 0; }
        .markdown-preview img { max-width: 100%; height: auto; border-radius: 5px; margin: 1em 0; }
        .markdown-preview del { text-decoration: line-through; opacity: 0.7; }
        .markdown-preview strong {
            font-weight: 900;
            color: #ffffff;
            text-shadow:
                0 0 10px rgba(255, 255, 255, 0.5),
                0 0 20px rgba(255, 255, 255, 0.3),
                0 0 30px rgba(255, 255, 255, 0.15);
            letter-spacing: 0.01em;
        }
        .markdown-preview em { font-style: italic; color: #6b7280; }
        .markdown-preview strong em, .markdown-preview em strong {
            font-weight: 900;
            font-style: italic;
            color: #ffffff;
            text-shadow:
                0 0 10px rgba(255, 255, 255, 0.5),
                0 0 20px rgba(255, 255, 255, 0.3),
                0 0 30px rgba(255, 255, 255, 0.15);
        }
        .markdown-preview ul.contains-task-list { list-style: none !important; margin-left: 1em; padding-left: 0; }
        .markdown-preview ul.contains-task-list li { margin-left: 0; }
        .markdown-preview input[type="checkbox"] { margin-right: 0.5em; cursor: pointer; }
        .markdown-preview input[type="checkbox"]:disabled { cursor: default; }
        .markdown-preview sup { vertical-align: super; font-size: smaller; }
        .markdown-preview sub { vertical-align: sub; font-size: smaller; }
        #noteTitle:disabled { opacity: 1; cursor: default; }

        /* Markmap容器样式 */
        #markmapSection {
            flex: 1;
            background: radial-gradient(circle at center, #0a0a0a 0%, #000000 100%);
            overflow: hidden;
            position: relative;
        }

        /* 添加网格背景效果 */
        #markmapSection::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                linear-gradient(90deg, rgba(96, 165, 250, 0.05) 1px, transparent 1px),
                linear-gradient(rgba(96, 165, 250, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            opacity: 0.3;
            z-index: 0;
        }

        #markmapSection svg {
            width: 100%;
            height: 100%;
            display: block;
            position: relative;
            z-index: 1;
        }

        /* Markmap文字样式 - 更大更清晰 */
        #markmapSection svg text,
        #markmapSection svg tspan {
            fill: #374151 !important;
            font-size: 18px !important;
            font-weight: 400 !important;
            text-shadow: 0 0 8px rgba(0, 0, 0, 0.8), 0 0 3px rgba(0, 0, 0, 0.9) !important;
        }

        #markmapSection svg strong,
        #markmapSection svg b {
            fill: #ffffff !important;
            font-weight: 900 !important;
            text-shadow:
                0 0 15px rgba(255, 255, 255, 0.6),
                0 0 25px rgba(255, 255, 255, 0.4),
                0 0 35px rgba(255, 255, 255, 0.2) !important;
        }

        /* 优化连接线 */
        #markmapSection svg path.markmap-link {
            stroke-width: 2.5px !important;
            opacity: 0.6 !important;
        }

        /* 优化节点圆圈 */
        #markmapSection svg circle {
            stroke-width: 3px !important;
            filter: drop-shadow(0 0 8px currentColor) brightness(1.2) !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
        }

        #markmapSection svg circle:hover {
            filter: drop-shadow(0 0 12px currentColor) brightness(1.4) !important;
            transform: scale(1.1) !important;
        }

        /* 优化文字描边效果 */
        #markmapSection svg foreignObject {
            overflow: visible !important;
        }

        #markmapSection svg foreignObject div {
            color: #f3f4f6 !important;
            text-shadow:
                -1px -1px 0 #000,
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000,
                0 0 8px rgba(0, 0, 0, 0.9),
                0 0 4px rgba(0, 0, 0, 0.8) !important;
            font-weight: 500 !important;
        }

        /* 根节点特殊样式 */
        #markmapSection svg > g > g:first-child circle {
            stroke-width: 4px !important;
            filter: drop-shadow(0 0 12px currentColor) brightness(1.3) !important;
        }

        #markmapSection svg > g > g:first-child text {
            font-size: 20px !important;
            font-weight: 700 !important;
        }

        /* 代码区块样式优化 - 深灰背景 */
        #markmapSection svg code,
        #markmapSection svg foreignObject code {
            background-color: #1e1e1e !important;
            color: #d4d4d4 !important;
            padding: 3px 8px !important;
            border-radius: 4px !important;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important;
            font-size: 14px !important;
            font-weight: 400 !important;
            border: 1px solid #3a3a3a !important;
            text-shadow: none !important;
        }

        #markmapSection svg pre,
        #markmapSection svg foreignObject pre {
            background-color: #1e1e1e !important;
            color: #d4d4d4 !important;
            padding: 12px !important;
            border-radius: 6px !important;
            border: 1px solid #3a3a3a !important;
            margin: 4px 0 !important;
        }

        #markmapSection svg pre code,
        #markmapSection svg foreignObject pre code {
            background-color: transparent !important;
            border: none !important;
            padding: 0 !important;
        }

        /* 确保代码区块内的文字不继承描边效果 */
        #markmapSection svg code *,
        #markmapSection svg pre *,
        #markmapSection svg foreignObject code *,
        #markmapSection svg foreignObject pre * {
            text-shadow: none !important;
            stroke: none !important;
            font-weight: 400 !important;
        }

        /* 行内代码样式 */
        #markmapSection svg foreignObject div code {
            background-color: #1e1e1e !important;
            color: #d4d4d4 !important;
            padding: 2px 6px !important;
            border-radius: 3px !important;
            font-size: 13px !important;
            font-weight: 400 !important;
            border: 1px solid #3a3a3a !important;
        }

        /* 全屏模式样式 */
        .fullscreen-mode {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
            background-color: #000000 !important;
            flex: none !important;
        }

        .fullscreen-mode .fullscreen-content {
            width: 100% !important;
            height: calc(100% - 48px) !important;
        }

        /* 全屏时的标题栏 */
        .fullscreen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background-color: #0a0a0a;
            border-bottom: 1px solid #2a2a2a;
        }

        /* 全屏按钮样式 */
        .fullscreen-btn {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .fullscreen-btn:hover {
            background-color: rgba(59, 130, 246, 0.2);
        }

        /* 可拖动分隔条样式 */
        .resize-handle {
            width: 4px;
            background-color: #2a2a2a;
            cursor: col-resize;
            flex-shrink: 0;
            position: relative;
            transition: background-color 0.2s;
        }

        .resize-handle:hover {
            background-color: #3b82f6;
        }

        .resize-handle:active {
            background-color: #60a5fa;
        }

        /* 拖动时的视觉反馈 */
        .resize-handle::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 40px;
            background: linear-gradient(90deg,
                transparent 0%,
                rgba(59, 130, 246, 0.1) 25%,
                rgba(59, 130, 246, 0.2) 50%,
                rgba(59, 130, 246, 0.1) 75%,
                transparent 100%);
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .resize-handle:hover::after {
            opacity: 1;
        }

        /* 拖动时禁用选择 */
        body.resizing {
            user-select: none;
            cursor: col-resize !important;
        }

        body.resizing * {
            cursor: col-resize !important;
        }

        /* Zoom controls styling */
        .zoom-btn {
            font-weight: 600;
            min-width: 48px;
            text-align: center;
        }

        .zoom-btn:hover {
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.3);
        }

        /* Markdown preview zoom and pan effect */
        .markdown-preview {
            transform-origin: top left;
            transition: transform 0.2s ease-out;
            cursor: default;
            width: fit-content;
            min-width: 100%;
        }

        .markdown-preview.dragging {
            cursor: grabbing !important;
            transition: none;
            user-select: none;
        }

        .markdown-preview.zoomed {
            cursor: grab;
        }
    </style>
</head>
<body class="bg-gray-900">
    <div class="h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 text-white px-4 py-3 shadow-lg border-b border-gray-700">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-xl font-bold tracking-tight">📝 Markdown Note Cloud</h1>
                <div class="flex items-center gap-3">
                    <span id="dbStatus" class="text-xs text-gray-400 bg-gray-800/50 px-3 py-1.5 rounded-full border border-gray-700">💾 IndexedDB 儲存模式</span>
                    <button id="helpBtn" class="bg-blue-600 hover:bg-blue-700 text-white py-1.5 px-4 rounded-lg text-xs font-semibold transition-all hover:shadow-lg hover:shadow-blue-500/20">
                        ❓ 使用說明
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Sidebar -->
            <aside class="w-72 bg-gray-800 border-r border-gray-700/50 flex flex-col">
                <div class="p-3 border-b border-gray-700/50 space-y-2">
                    <button id="newNoteBtn" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold py-2 px-4 rounded-lg text-sm transition-all shadow-md hover:shadow-lg hover:shadow-blue-500/30">
                        ➕ 新增筆記
                    </button>
                    <button id="overviewBtn" class="w-full bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white font-semibold py-2 px-4 rounded-lg text-sm transition-all shadow-md hover:shadow-lg hover:shadow-indigo-500/30">
                        📋 筆記總覽
                    </button>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="exportBtn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-1.5 px-3 rounded-lg text-xs transition-all">
                            📤 匯出
                        </button>
                        <button id="importBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-1.5 px-3 rounded-lg text-xs transition-all">
                            📥 匯入
                        </button>
                    </div>
                    <button id="autoBackupBtn" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-medium py-1.5 px-3 rounded-lg text-xs transition-all">
                        💾 設定自動備份
                    </button>
                    <div id="autoBackupStatus" class="text-xs text-green-400 text-center hidden bg-green-500/10 py-1 rounded">
                        🔄 自動備份已啟用
                    </div>
                    <input type="file" id="importFileInput" accept=".json" class="hidden">
                </div>
                <div class="p-3 border-b border-gray-700/50">
                    <div class="relative">
                        <input
                            id="searchInput"
                            type="text"
                            placeholder="🔍 搜尋筆記..."
                            class="w-full bg-gray-700/50 text-gray-100 placeholder-gray-400 rounded-lg py-2 px-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 border border-gray-600/50 focus:border-blue-500/50 transition-all">
                        <button id="clearSearchBtn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-200 hidden">
                            ✕
                        </button>
                    </div>
                    <div id="searchStats" class="mt-2 text-xs text-blue-400 bg-blue-500/10 px-2 py-1 rounded hidden">
                        找到 <span id="searchCount">0</span> 筆結果
                    </div>
                </div>
                <div id="noteList" class="flex-1 overflow-y-auto"></div>
            </aside>

            <!-- Editor -->
            <main class="flex-1 flex flex-col bg-gray-800">
                <div class="px-3 py-2 border-b border-gray-700/50 bg-gradient-to-b from-gray-800 to-gray-800/95">
                    <div class="flex items-center justify-between gap-3">
                        <input id="noteTitle" type="text" placeholder="輸入筆記標題..."
                               class="flex-1 text-base font-bold outline-none bg-transparent text-gray-100 placeholder-gray-500/70 disabled:cursor-default" disabled>

                        <!-- Tags and Timestamp in one line -->
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <div class="flex flex-wrap gap-1 items-center">
                                <div id="tagsContainer" class="flex flex-wrap gap-1">
                                    <!-- Tags will be displayed here -->
                                </div>
                                <input id="tagInput" type="text" placeholder="+ 標籤" list="tagSuggestions"
                                       class="w-16 px-2 py-0.5 text-xs bg-gray-700/50 text-gray-100 placeholder-gray-500 rounded-md outline-none focus:ring-1 focus:ring-blue-500 border border-gray-600/50 focus:border-blue-500/50 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                                       disabled>
                                <datalist id="tagSuggestions">
                                    <!-- Tag suggestions will be populated dynamically -->
                                </datalist>
                            </div>
                            <div id="noteTimestamp" class="text-xs text-gray-500 flex items-center gap-2 hidden">
                                <span id="createdTime" class="flex items-center gap-1">📅</span>
                                <span class="text-gray-600">•</span>
                                <span id="updatedTime" class="flex items-center gap-1">🔄</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex-1 flex overflow-hidden">
                    <div id="editorSection" class="flex-1 flex flex-col">
                        <div class="px-3 py-1.5 bg-gray-900 border-b border-gray-700">
                            <span class="text-xs font-medium text-gray-400">✏️ 編輯器</span>
                        </div>
                        <textarea id="noteContent" placeholder="在此輸入 Markdown 內容..."
                                  class="flex-1 p-4 outline-none resize-none font-mono text-sm bg-gray-800 text-gray-100 placeholder-gray-500" disabled></textarea>
                    </div>
                    <div id="resizeHandle" class="resize-handle" title="拖動調整大小"></div>
                    <div id="previewSection" class="flex-1 flex flex-col">
                        <div class="px-3 py-1.5 bg-gray-900 border-b border-gray-700 flex justify-between items-center">
                            <span class="text-xs font-medium text-gray-400">📄 Markdown</span>
                            <div class="flex items-center gap-1">
                                <button id="zoomOutBtn" class="zoom-btn bg-gray-700 hover:bg-gray-600 text-gray-300 text-xs py-0.5 px-2 rounded transition-colors" title="縮小 (Ctrl/Cmd + -)">
                                    🔍−
                                </button>
                                <button id="zoomResetBtn" class="zoom-btn bg-gray-700 hover:bg-gray-600 text-gray-300 text-xs py-0.5 px-2 rounded transition-colors" title="重置縮放">
                                    <span id="zoomLevel">100%</span>
                                </button>
                                <button id="zoomInBtn" class="zoom-btn bg-gray-700 hover:bg-gray-600 text-gray-300 text-xs py-0.5 px-2 rounded transition-colors" title="放大 (Ctrl/Cmd + +)">
                                    🔍+
                                </button>
                                <button id="previewFullscreenBtn" class="fullscreen-btn text-gray-400 hover:text-gray-200 text-base" title="全屏查看">
                                    ⛶
                                </button>
                            </div>
                        </div>
                        <div id="markdownPreview" class="fullscreen-content flex-1 p-4 overflow-y-auto markdown-preview text-gray-100">
                            <p class="text-gray-500">Markdown 渲染區域</p>
                        </div>
                    </div>
                    <div id="markmapSection" class="hidden flex-1 flex-col">
                        <div class="px-3 py-1.5 bg-gray-900 border-b border-gray-700 flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-medium text-gray-400">🗺️ 思維導圖</span>
                                <div class="flex gap-1">
                                    <button id="expandAllBtn" class="bg-green-600 hover:bg-green-700 text-white text-xs py-0.5 px-2 rounded transition-colors" title="展開所有節點">
                                        ➕ 展開
                                    </button>
                                    <button id="collapseAllBtn" class="bg-orange-600 hover:bg-orange-700 text-white text-xs py-0.5 px-2 rounded transition-colors" title="摺疊所有節點">
                                        ➖ 摺疊
                                    </button>
                                    <button id="fitViewBtn" class="bg-blue-600 hover:bg-blue-700 text-white text-xs py-0.5 px-2 rounded transition-colors" title="適配視圖">
                                        🎯 適配
                                    </button>
                                </div>
                            </div>
                            <button id="markmapFullscreenBtn" class="fullscreen-btn text-gray-400 hover:text-gray-200 text-base" title="全屏查看">
                                ⛶
                            </button>
                        </div>
                        <div id="markmapContainer" class="fullscreen-content flex-1">
                            <svg id="markmapSvg"></svg>
                        </div>
                    </div>
                </div>
                <div class="px-3 py-2 border-t border-gray-700/50 flex justify-between items-center bg-gradient-to-t from-gray-800 to-gray-800/95">
                    <div class="flex items-center gap-2">
                        <span id="saveStatus" class="text-xs text-gray-400 bg-gray-700/30 px-2.5 py-1 rounded-full border border-gray-700/50">請選擇或建立筆記</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                        <button id="viewModeBtn" class="bg-purple-600 hover:bg-purple-700 text-white py-1 px-3 rounded-lg text-xs font-medium disabled:bg-gray-600 disabled:cursor-not-allowed transition-all shadow-md hover:shadow-lg disabled:shadow-none" disabled>
                            🗺️ 思維導圖
                        </button>
                        <button id="toggleModeBtn" class="bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded-lg text-xs font-medium disabled:bg-gray-600 disabled:cursor-not-allowed transition-all shadow-md hover:shadow-lg disabled:shadow-none" disabled>
                            ✏️ 編輯
                        </button>
                        <button id="deleteNoteBtn" class="bg-red-600 hover:bg-red-700 text-white py-1 px-3 rounded-lg text-xs font-medium disabled:bg-gray-600 disabled:cursor-not-allowed transition-all shadow-md hover:shadow-lg disabled:shadow-none" disabled>
                            🗑️ 刪除
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <!-- Help Modal -->
        <div id="helpModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
                <!-- Modal Header -->
                <div class="sticky top-0 bg-gray-800 border-b border-gray-700 p-6 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-100">📖 使用說明</h2>
                    <button id="closeHelpBtn" class="text-gray-400 hover:text-gray-200 text-3xl leading-none">
                        ×
                    </button>
                </div>

                <!-- Modal Content -->
                <div class="p-6 text-gray-200 space-y-6">
                    <!-- 開發者資訊 -->
                    <div class="text-left py-2 border-b border-gray-600">
                        <p class="text-gray-300">開發者 - <span class="text-blue-400 font-semibold">QA陳彥良</span></p>
                    </div>

                    <!-- 功能介紹 -->
                    <section>
                        <h3 class="text-xl font-bold text-blue-400 mb-3">✨ 功能特色</h3>
                        <ul class="list-disc list-inside space-y-2 text-gray-300">
                            <li><strong class="text-green-400">🚀 IndexedDB 儲存：</strong>開箱即用，無需設定，自動儲存所有筆記</li>
                            <li>📄 支援完整 GitHub Flavored Markdown (GFM) 語法</li>
                            <li>🔍 縮放與拖動：滑鼠滾輪縮放 (50%-200%)，放大後可拖動查看，支援鍵盤快捷鍵</li>
                            <li>🗺️ 思維導圖視圖：將筆記轉換為互動式心智圖</li>
                            <li>🏷️ 標籤管理：支援多標籤分類，自動完成輸入，按標籤篩選筆記</li>
                            <li>📋 筆記總覽：緊湊式列表顯示所有筆記，支援排序和篩選</li>
                            <li>⛶ 全屏模式：Markdown 與思維導圖可切換為全瀏覽器範圍查看</li>
                            <li>↔️ 可調整編輯器與預覽區域的寬度比例，雙擊重置</li>
                            <li>🎨 程式碼語法高亮：支援 180+ 種程式語言</li>
                            <li>✅ 支援任務列表、表格、刪除線等 GFM 擴展語法</li>
                            <li>✏️ 三種視圖模式：閱讀 / 編輯 / 思維導圖</li>
                            <li>🔍 全文檢索：即時搜尋標題和內容，關鍵字高亮顯示</li>
                            <li>📤📥 資料匯出/匯入：支援備份和還原所有筆記</li>
                            <li>📅 時間標記：自動記錄建立時間與最後更新時間</li>
                            <li>💾 自動儲存：編輯後 1.5 秒自動儲存到 IndexedDB</li>
                            <li>🌓 純黑深色模式：OLED 友善的純黑界面</li>
                            <li>🔐 安全保護：防止 XSS 攻擊</li>
                        </ul>
                    </section>

                    <!-- 基本操作 -->
                    <section>
                        <h3 class="text-xl font-bold text-green-400 mb-3">📝 基本操作</h3>

                        <div class="space-y-4">
                            <div>
                                <h4 class="font-semibold text-gray-100 mb-2">1️⃣ 建立筆記</h4>
                                <p class="text-gray-300 ml-4">點擊左側面板的「➕ 新增筆記」按鈕，系統會自動建立一篇新筆記並進入編輯模式。</p>
                            </div>

                            <div>
                                <h4 class="font-semibold text-gray-100 mb-2">2️⃣ 編輯筆記</h4>
                                <p class="text-gray-300 ml-4">
                                    • 點擊筆記列表中的任一筆記，預設會進入 <strong>Markdown 模式</strong>（純閱讀）<br>
                                    • 點擊右下角「✏️ 編輯」按鈕進入編輯模式<br>
                                    • 在編輯模式下，左側為編輯器，右側即時預覽 Markdown 渲染結果<br>
                                    • <strong>可拖動中間分隔條</strong>調整編輯器與預覽區域的寬度<br>
                                    • 雙擊分隔條可快速重置為 50/50 比例<br>
                                    • 調整的寬度設定會自動保存，下次開啟時保持相同比例<br>
                                    • 完成編輯後點擊「✅ 完成」返回 Markdown 模式
                                </p>
                            </div>

                            <div>
                                <h4 class="font-semibold text-gray-100 mb-2">3️⃣ 思維導圖視圖</h4>
                                <p class="text-gray-300 ml-4">
                                    • 選擇筆記後，點擊右下角「🗺️ 思維導圖」按鈕<br>
                                    • 筆記會自動轉換為彩色互動式心智圖<br>
                                    • 點擊節點圓圈可展開/收起分支<br>
                                    • 滾動滑鼠滾輪可縮放視圖<br>
                                    • 拖曳可移動視圖位置<br>
                                    • 點擊「📄 返回閱讀」返回正常視圖
                                </p>
                            </div>

                            <div>
                                <h4 class="font-semibold text-gray-100 mb-2">4️⃣ 全屏模式</h4>
                                <p class="text-gray-300 ml-4">
                                    • 在 Markdown 閱讀模式或思維導圖模式下，點擊右上角的 ⛶ 按鈕進入全屏<br>
                                    • 全屏模式下可以更專注地閱讀或查看思維導圖<br>
                                    • 點擊 ⛉ 按鈕或按 ESC 鍵退出全屏<br>
                                    • 全屏模式會自動調整視圖大小以最佳化顯示
                                </p>
                            </div>

                            <div>
                                <h4 class="font-semibold text-gray-100 mb-2">5️⃣ 縮放與拖動功能</h4>
                                <p class="text-gray-300 ml-4">
                                    • 在 Markdown 預覽區域的工具欄中，可以使用縮放控制按鈕<br>
                                    • 🔍+ 放大：增加內容顯示大小（最大 200%）<br>
                                    • 🔍− 縮小：減少內容顯示大小（最小 50%）<br>
                                    • 點擊百分比按鈕可重置為 100%<br>
                                    • <strong>鍵盤快捷鍵：</strong><br>
                                    &nbsp;&nbsp;- Ctrl/Cmd + Plus (+) 放大<br>
                                    &nbsp;&nbsp;- Ctrl/Cmd + Minus (-) 縮小<br>
                                    &nbsp;&nbsp;- Ctrl/Cmd + 0 重置為 100%<br>
                                    • <strong>滑鼠滾輪縮放：</strong><br>
                                    &nbsp;&nbsp;- 按住 Ctrl/Cmd + 滾動滑鼠滾輪可縮放<br>
                                    &nbsp;&nbsp;- 縮放會以滑鼠指標位置為中心<br>
                                    • <strong>拖動查看：</strong><br>
                                    &nbsp;&nbsp;- 當內容放大後（>100%），可直接拖動內容查看不同位置<br>
                                    &nbsp;&nbsp;- 滑鼠游標會變成手掌圖示，點擊並拖動即可<br>
                                    • 縮放比例會自動保存，下次開啟時保持相同設定
                                </p>
                            </div>

                            <div>
                                <h4 class="font-semibold text-gray-100 mb-2">6️⃣ 標籤管理</h4>
                                <p class="text-gray-300 ml-4">
                                    • 選擇筆記後，在標題下方的標籤輸入框中輸入標籤名稱<br>
                                    • 點擊輸入框會顯示已存在的標籤列表（按 a-z 排序）<br>
                                    • 可以選擇現有標籤或輸入新標籤名稱<br>
                                    • 按 Enter 鍵新增標籤<br>
                                    • 點擊標籤上的「×」刪除該標籤<br>
                                    • 使用左側面板的標籤篩選器，可以按標籤篩選筆記
                                </p>
                            </div>

                            <div>
                                <h4 class="font-semibold text-gray-100 mb-2">7️⃣ 筆記總覽</h4>
                                <p class="text-gray-300 ml-4">
                                    • 點擊左側面板的「📋 筆記總覽」按鈕<br>
                                    • 以緊湊列表形式查看所有筆記<br>
                                    • 顯示筆記標題、創建日期、更新日期和標籤<br>
                                    • 支援搜尋和排序功能<br>
                                    • 點擊筆記標題即可開啟該筆記
                                </p>
                            </div>

                            <div>
                                <h4 class="font-semibold text-gray-100 mb-2">8️⃣ 刪除筆記</h4>
                                <p class="text-gray-300 ml-4">選擇筆記後，點擊右下角「🗑️ 刪除筆記」按鈕，確認後即可刪除。</p>
                            </div>
                        </div>
                    </section>

                    <!-- 搜尋功能 -->
                    <section>
                        <h3 class="text-xl font-bold text-purple-400 mb-3">🔍 搜尋功能</h3>
                        <div class="text-gray-300 ml-4 space-y-2">
                            <p>• 在左側面板的搜尋框輸入關鍵字</p>
                            <p>• 系統會即時搜尋筆記標題和內容</p>
                            <p>• 搜尋結果會以黃色高亮顯示關鍵字</p>
                            <p>• 顯示找到的筆記數量統計</p>
                            <p>• 點擊「✕」或按 ESC 鍵清除搜尋</p>
                        </div>
                    </section>

                    <!-- 儲存系統 -->
                    <section>
                        <h3 class="text-xl font-bold text-orange-400 mb-3">💾 IndexedDB 儲存系統</h3>

                        <div class="space-y-4">
                            <div>
                                <h4 class="font-semibold text-gray-100 mb-2">🚀 開箱即用</h4>
                                <p class="text-gray-300 ml-4">
                                    應用程式使用瀏覽器內建的 <strong>IndexedDB</strong> 資料庫自動儲存所有筆記。<br>
                                    無需任何設定或選擇目錄，開啟即可使用！<br>
                                    <span class="text-green-400">✅ 比 localStorage 更快、更穩定、容量更大</span>
                                </p>
                            </div>

                            <div>
                                <h4 class="font-semibold text-gray-100 mb-2">💾 自動儲存</h4>
                                <p class="text-gray-300 ml-4">
                                    所有的筆記修改都會在 1.5 秒後自動儲存到 IndexedDB。<br>
                                    資料儲存在瀏覽器本地，完全離線可用，不會上傳到網路。<br>
                                    右上角會顯示當前已載入的筆記數量。
                                </p>
                            </div>

                            <div>
                                <h4 class="font-semibold text-gray-100 mb-2">🔄 資料遷移</h4>
                                <p class="text-gray-300 ml-4">
                                    如果您之前使用舊版本（localStorage 儲存），首次開啟時會自動檢測並提示您遷移資料。<br>
                                    選擇「確定」後，系統會將所有舊資料自動轉移到新的 IndexedDB 資料庫中。
                                </p>
                            </div>

                            <div class="bg-blue-900/30 p-3 rounded-lg">
                                <h4 class="font-semibold text-blue-300 mb-2">ℹ️ 關於 IndexedDB</h4>
                                <p class="text-gray-300 text-sm ml-4">
                                    IndexedDB 是瀏覽器內建的 NoSQL 資料庫，提供：<br>
                                    • 更大的儲存空間（通常 50MB 起跳，某些瀏覽器無限制）<br>
                                    • 更快的讀寫速度<br>
                                    • 支援索引和複雜查詢<br>
                                    • 資料持久保存（除非手動清除瀏覽器資料）
                                </p>
                            </div>
                        </div>
                    </section>

                    <!-- 匯出匯入 -->
                    <section>
                        <h3 class="text-xl font-bold text-yellow-400 mb-3">💾 資料備份與還原</h3>

                        <div class="space-y-4">
                            <div>
                                <h4 class="font-semibold text-gray-100 mb-2">📤 匯出資料</h4>
                                <p class="text-gray-300 ml-4">
                                    點擊左側面板的「📤 匯出」按鈕，系統會將所有筆記匯出為 JSON 格式檔案。<br>
                                    檔案名稱格式：<code class="bg-gray-700 px-2 py-1 rounded">markdown-notes-backup-YYYY-MM-DD-HH-MM-SS.json</code><br>
                                    <span class="text-blue-400">💡 提示：現在您已經有自動儲存的 JSON 檔案，匯出功能主要用於建立額外的備份。</span>
                                </p>
                            </div>

                            <div>
                                <h4 class="font-semibold text-gray-100 mb-2">📥 匯入資料</h4>
                                <p class="text-gray-300 ml-4">
                                    點擊左側面板的「📥 匯入」按鈕，選擇之前匯出的 JSON 檔案。<br>
                                    系統會顯示匯入預覽資訊，並提供兩種匯入模式：<br>
                                    <span class="block mt-2">
                                        • <strong>覆蓋模式</strong>（點擊「確定」）：刪除現有所有筆記，完全替換為匯入的資料<br>
                                        • <strong>合併模式</strong>（點擊「取消」）：保留現有筆記，只新增不重複的筆記
                                    </span>
                                </p>
                            </div>
                        </div>
                    </section>

                    <!-- Markdown 語法 -->
                    <section>
                        <h3 class="text-xl font-bold text-pink-400 mb-3">📝 Markdown 語法參考</h3>
                        <div class="bg-gray-900 p-4 rounded-lg text-sm space-y-3 font-mono text-gray-300">
                            <div>
                                <p class="text-blue-400 mb-1">標題：</p>
                                <p># 標題 1  ## 標題 2  ### 標題 3</p>
                            </div>
                            <div>
                                <p class="text-blue-400 mb-1">文字樣式：</p>
                                <p>**粗體** *斜體* ~~刪除線~~</p>
                            </div>
                            <div>
                                <p class="text-blue-400 mb-1">列表：</p>
                                <p>- 項目列表</p>
                                <p>1. 編號列表</p>
                                <p>- [ ] 任務列表（未完成）</p>
                                <p>- [x] 任務列表（已完成）</p>
                            </div>
                            <div>
                                <p class="text-blue-400 mb-1">連結與圖片：</p>
                                <p>[連結文字](https://example.com)</p>
                                <p>![圖片描述](圖片網址)</p>
                            </div>
                            <div>
                                <p class="text-blue-400 mb-1">程式碼：</p>
                                <p>`行內程式碼`</p>
                                <p>```javascript<br>// 程式碼區塊（支援語法高亮）<br>console.log('Hello');<br>```</p>
                                <p class="text-xs text-gray-500 mt-1">* 思維導圖中，程式碼會以深灰背景顯示</p>
                            </div>
                            <div>
                                <p class="text-blue-400 mb-1">引用與分隔線：</p>
                                <p>&gt; 引用文字</p>
                                <p>---</p>
                            </div>
                            <div>
                                <p class="text-blue-400 mb-1">表格：</p>
                                <p>| 欄位1 | 欄位2 |</p>
                                <p>|-------|-------|</p>
                                <p>| 內容1 | 內容2 |</p>
                            </div>
                        </div>
                    </section>

                    <!-- 快捷提示 -->
                    <section>
                        <h3 class="text-xl font-bold text-cyan-400 mb-3">💡 使用提示</h3>
                        <ul class="list-disc list-inside space-y-2 text-gray-300">
                            <li><strong class="text-green-400">開箱即用！</strong> 使用 IndexedDB 資料庫自動儲存，無需任何設定</li>
                            <li>所有資料儲存在瀏覽器本地，完全離線可用，不會上傳到網路</li>
                            <li>筆記按最後更新時間排序，最新的在最上方</li>
                            <li>編輯時會在 1.5 秒後自動儲存，避免資料遺失</li>
                            <li>右上角顯示當前已載入的筆記數量</li>
                            <li>定期使用「📤 匯出」功能備份重要筆記</li>
                            <li>清除瀏覽器資料會導致筆記遺失，請務必先備份</li>
                            <li>編輯器與預覽區域的寬度比例會自動保存，可依個人習慣調整</li>
                            <li><strong class="text-green-400">相容性：</strong> 支援所有現代瀏覽器（Chrome、Firefox、Safari、Edge 等）</li>
                        </ul>
                    </section>

                    <!-- 技術資訊 -->
                    <section class="border-t border-gray-700 pt-4">
                        <h3 class="text-lg font-bold text-gray-400 mb-2">🔧 技術資訊</h3>
                        <p class="text-gray-400 text-sm">
                            本應用使用 Tailwind CSS、marked.js（Markdown 渲染）、highlight.js（程式碼語法高亮）、<br>
                            markmap（思維導圖）、D3.js（資料視覺化）、DOMPurify（安全防護）開發。<br>
                            純前端應用，無需伺服器，可離線使用。
                        </p>
                    </section>
                </div>

                <!-- Modal Footer -->
                <div class="sticky bottom-0 bg-gray-800 border-t border-gray-700 p-4 flex justify-end">
                    <button id="closeHelpBtn2" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded-lg font-semibold">
                        關閉
                    </button>
                </div>
            </div>
        </div>

        <!-- Overview Modal -->
        <div id="overviewModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-xl max-w-5xl w-full max-h-[90vh] flex flex-col shadow-2xl border border-gray-700/50">
                <!-- Modal Header -->
                <div class="bg-gradient-to-r from-gray-800 to-gray-800/95 border-b border-gray-700/50 px-5 py-3.5 flex justify-between items-center flex-shrink-0 rounded-t-xl">
                    <h2 class="text-xl font-bold text-gray-100">📋 筆記總覽</h2>
                    <button id="closeOverviewBtn" class="text-gray-400 hover:text-gray-200 text-2xl leading-none w-8 h-8 flex items-center justify-center hover:bg-gray-700/50 rounded-lg transition-all">
                        ×
                    </button>
                </div>

                <!-- Search and Sort Controls -->
                <div class="bg-gray-900/50 border-b border-gray-700/50 p-3 flex-shrink-0">
                    <div class="flex gap-3 items-center mb-2.5">
                        <div class="flex-1 relative">
                            <input
                                id="overviewSearchInput"
                                type="text"
                                placeholder="🔍 搜尋筆記名稱..."
                                class="w-full bg-gray-700/50 text-gray-100 placeholder-gray-400 rounded-lg py-2 px-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 border border-gray-600/50 focus:border-blue-500/50 transition-all">
                            <button id="clearOverviewSearchBtn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-200 hidden">
                                ✕
                            </button>
                        </div>
                        <div class="flex gap-2 items-center">
                            <label class="text-xs text-gray-400 whitespace-nowrap font-medium">排序：</label>
                            <select id="sortSelect" class="bg-gray-700/50 text-gray-100 rounded-lg py-2 px-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer border border-gray-600/50 transition-all">
                                <option value="updatedAt-desc">最後更新 ↓</option>
                                <option value="updatedAt-asc">最後更新 ↑</option>
                                <option value="createdAt-desc">創建時間 ↓</option>
                                <option value="createdAt-asc">創建時間 ↑</option>
                                <option value="title-asc">名稱 A-Z</option>
                                <option value="title-desc">名稱 Z-A</option>
                            </select>
                        </div>
                    </div>
                    <!-- Tag Filter -->
                    <div class="flex gap-2 items-center">
                        <label class="text-xs text-gray-400 whitespace-nowrap font-medium">🏷️</label>
                        <select id="tagFilter" class="flex-1 bg-gray-700/50 text-gray-100 rounded-lg py-2 px-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer border border-gray-600/50 transition-all">
                            <option value="">全部標籤</option>
                            <!-- Tags will be populated dynamically -->
                        </select>
                    </div>
                </div>

                <!-- Stats -->
                <div class="bg-gray-900/30 border-b border-gray-700/50 px-4 py-2 flex justify-between items-center text-xs flex-shrink-0">
                    <span class="text-gray-400">共 <span id="totalNotesCount" class="text-blue-400 font-semibold">0</span> 筆筆記</span>
                    <span id="overviewSearchStats" class="text-gray-400 hidden">找到 <span id="overviewSearchCount" class="text-green-400 font-semibold">0</span> 筆結果</span>
                </div>

                <!-- Notes List -->
                <div id="overviewNotesList" class="flex-1 overflow-y-auto p-3">
                    <!-- Notes will be inserted here -->
                </div>

                <!-- Modal Footer -->
                <div class="bg-gradient-to-t from-gray-800 to-gray-800/95 border-t border-gray-700/50 px-4 py-3 flex justify-end flex-shrink-0 rounded-b-xl">
                    <button id="closeOverviewBtn2" class="bg-blue-600 hover:bg-blue-700 text-white py-1.5 px-5 rounded-lg font-medium text-sm transition-all shadow-md hover:shadow-lg">
                        關閉
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('Script started');

        // Configure marked.js for full GFM support
        marked.setOptions({
            gfm: true,              // GitHub Flavored Markdown
            breaks: true,           // Convert \n to <br>
            pedantic: false,
            sanitize: false,        // We use DOMPurify instead
            smartLists: true,
            smartypants: false,
            highlight: function(code, lang) {
                // Use highlight.js for syntax highlighting
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (err) {
                        console.error('Highlight error:', err);
                    }
                }
                return code;
            }
        });

        // Initialize Dexie Database
        const db = new Dexie('MarkdownNotesDB');
        db.version(1).stores({
            notes: 'id, title, content, createdAt, updatedAt'
        });
        db.version(2).stores({
            notes: 'id, title, content, createdAt, updatedAt',
            settings: 'key, value' // 用于存储文件句柄等设置
        });
        db.version(3).stores({
            notes: 'id, title, content, createdAt, updatedAt, *tags', // *tags 表示 tags 是多值索引
            settings: 'key, value'
        });

        // State
        let notes = [];
        let currentNoteId = null;
        let autoSaveTimeout = null;
        let isEditMode = true; // true: 编辑模式, false: 预览模式
        let isMarkmapView = false; // true: 思维导图视图, false: 正常视图
        let searchQuery = ''; // 搜索关键字
        let markmapInstance = null; // Markmap实例
        const markmapTransformer = typeof markmap !== 'undefined' ? new markmap.Transformer() : null;
        let editorWidth = 50; // 编辑器宽度百分比，默认50%
        let zoomScale = 1.0; // Markdown预览缩放比例，默认100%
        let panX = 0; // 平移X坐标
        let panY = 0; // 平移Y坐标
        let isDragging = false; // 是否正在拖动
        let dragStartX = 0; // 拖动起始X坐标
        let dragStartY = 0; // 拖动起始Y坐标

        // Elements
        const els = {
            newNoteBtn: document.getElementById('newNoteBtn'),
            noteList: document.getElementById('noteList'),
            noteTitle: document.getElementById('noteTitle'),
            noteContent: document.getElementById('noteContent'),
            markdownPreview: document.getElementById('markdownPreview'),
            deleteNoteBtn: document.getElementById('deleteNoteBtn'),
            saveStatus: document.getElementById('saveStatus'),
            toggleModeBtn: document.getElementById('toggleModeBtn'),
            viewModeBtn: document.getElementById('viewModeBtn'),
            editorSection: document.getElementById('editorSection'),
            previewSection: document.getElementById('previewSection'),
            markmapSection: document.getElementById('markmapSection'),
            markmapSvg: document.getElementById('markmapSvg'),
            searchInput: document.getElementById('searchInput'),
            clearSearchBtn: document.getElementById('clearSearchBtn'),
            searchStats: document.getElementById('searchStats'),
            searchCount: document.getElementById('searchCount'),
            noteTimestamp: document.getElementById('noteTimestamp'),
            createdTime: document.getElementById('createdTime'),
            updatedTime: document.getElementById('updatedTime'),
            exportBtn: document.getElementById('exportBtn'),
            importBtn: document.getElementById('importBtn'),
            importFileInput: document.getElementById('importFileInput'),
            helpBtn: document.getElementById('helpBtn'),
            helpModal: document.getElementById('helpModal'),
            closeHelpBtn: document.getElementById('closeHelpBtn'),
            closeHelpBtn2: document.getElementById('closeHelpBtn2'),
            previewFullscreenBtn: document.getElementById('previewFullscreenBtn'),
            markmapFullscreenBtn: document.getElementById('markmapFullscreenBtn'),
            resizeHandle: document.getElementById('resizeHandle'),
            dbStatus: document.getElementById('dbStatus'),
            expandAllBtn: document.getElementById('expandAllBtn'),
            collapseAllBtn: document.getElementById('collapseAllBtn'),
            fitViewBtn: document.getElementById('fitViewBtn'),
            autoBackupBtn: document.getElementById('autoBackupBtn'),
            autoBackupStatus: document.getElementById('autoBackupStatus'),
            overviewBtn: document.getElementById('overviewBtn'),
            overviewModal: document.getElementById('overviewModal'),
            closeOverviewBtn: document.getElementById('closeOverviewBtn'),
            closeOverviewBtn2: document.getElementById('closeOverviewBtn2'),
            overviewNotesList: document.getElementById('overviewNotesList'),
            overviewSearchInput: document.getElementById('overviewSearchInput'),
            clearOverviewSearchBtn: document.getElementById('clearOverviewSearchBtn'),
            sortSelect: document.getElementById('sortSelect'),
            totalNotesCount: document.getElementById('totalNotesCount'),
            overviewSearchStats: document.getElementById('overviewSearchStats'),
            overviewSearchCount: document.getElementById('overviewSearchCount'),
            tagInput: document.getElementById('tagInput'),
            tagsContainer: document.getElementById('tagsContainer'),
            tagFilter: document.getElementById('tagFilter'),
            zoomInBtn: document.getElementById('zoomInBtn'),
            zoomOutBtn: document.getElementById('zoomOutBtn'),
            zoomResetBtn: document.getElementById('zoomResetBtn'),
            zoomLevel: document.getElementById('zoomLevel')
        };

        // Dexie Database Functions
        async function loadNotes() {
            try {
                // 从 Dexie 加载所有笔记
                notes = await db.notes.orderBy('updatedAt').reverse().toArray();

                // 更新数据库状态
                els.dbStatus.textContent = `💾 已載入 ${notes.length} 筆筆記`;
                els.dbStatus.classList.remove('text-gray-400');
                els.dbStatus.classList.add('text-green-400');

                renderNoteList();
                updateTagSuggestions(); // 初始化标签建议

                // 检查是否有 localStorage 的旧数据需要迁移
                await migrateFromLocalStorage();
            } catch (err) {
                console.error('載入筆記失敗:', err);
                els.dbStatus.textContent = '❌ 載入失敗';
                els.dbStatus.classList.add('text-red-400');
                notes = [];
                renderNoteList();
            }
        }

        async function migrateFromLocalStorage() {
            try {
                // 检查 localStorage 中是否有旧数据
                const oldData = localStorage.getItem('demo-notes');
                if (!oldData) return;

                const oldNotes = JSON.parse(oldData);
                if (oldNotes.length === 0) return;

                // 检查 Dexie 中是否已有数据
                const existingCount = await db.notes.count();
                if (existingCount > 0) {
                    // 如果已有数据，询问用户
                    const migrate = confirm(
                        `檢測到 localStorage 中有 ${oldNotes.length} 筆舊資料\n` +
                        `當前資料庫已有 ${existingCount} 筆資料\n\n` +
                        `是否要合併舊資料到 IndexedDB？`
                    );
                    if (!migrate) return;
                }

                // 迁移数据到 Dexie
                await db.notes.bulkPut(oldNotes);
                notes = await db.notes.orderBy('updatedAt').reverse().toArray();
                renderNoteList();

                // 迁移成功后删除 localStorage 数据
                localStorage.removeItem('demo-notes');

                alert(`成功遷移 ${oldNotes.length} 筆筆記到 IndexedDB！`);
                els.dbStatus.textContent = `💾 已載入 ${notes.length} 筆筆記`;
            } catch (err) {
                console.error('遷移數據失敗:', err);
                alert('遷移舊資料失敗：' + err.message);
            }
        }

        async function saveNoteToDb(note) {
            try {
                await db.notes.put(note);
                console.log('筆記已保存到 IndexedDB:', note.id);
            } catch (err) {
                console.error('儲存筆記失敗:', err);
                // 降级到 localStorage
                localStorage.setItem('demo-notes-backup', JSON.stringify(notes));
            }
        }

        async function deleteNoteFromDb(noteId) {
            try {
                await db.notes.delete(noteId);
                console.log('筆記已從 IndexedDB 刪除:', noteId);
            } catch (err) {
                console.error('刪除筆記失敗:', err);
            }
        }

        function renderNoteList() {
            // 搜索过滤
            let filteredNotes = notes;
            if (searchQuery.trim()) {
                const query = searchQuery.toLowerCase();
                filteredNotes = notes.filter(note => {
                    const title = (note.title || '').toLowerCase();
                    const content = (note.content || '').toLowerCase();
                    return title.includes(query) || content.includes(query);
                });

                // 显示搜索统计
                els.searchStats.classList.remove('hidden');
                els.searchCount.textContent = filteredNotes.length;
            } else {
                // 隐藏搜索统计
                els.searchStats.classList.add('hidden');
            }

            if (notes.length === 0) {
                els.noteList.innerHTML = '<div class="p-4 text-center text-gray-400"><p>尚無筆記</p></div>';
                return;
            }

            if (filteredNotes.length === 0) {
                els.noteList.innerHTML = '<div class="p-4 text-center text-gray-400"><p>找不到符合的筆記</p><p class="text-xs mt-2">試試其他關鍵字</p></div>';
                return;
            }

            els.noteList.innerHTML = filteredNotes.map(note => {
                const active = note.id === currentNoteId ? 'active' : '';
                const title = highlightText(note.title || '無標題', searchQuery);
                const tags = note.tags || [];
                const tagsHTML = tags.length > 0 ? `
                    <div class="flex flex-wrap gap-1 mt-1.5">
                        ${tags.map(tag => `
                            <span class="inline-block px-2 py-0.5 bg-blue-600/50 text-xs text-blue-200 rounded-full">${escapeHtml(tag)}</span>
                        `).join('')}
                    </div>
                ` : '';

                return `
                    <div class="note-list-item p-3 cursor-pointer border-b border-gray-700 ${active}" onclick="selectNote('${note.id}')">
                        <h3 class="text-sm font-medium text-gray-200 leading-relaxed">${title}</h3>
                        ${tagsHTML}
                    </div>
                `;
            }).join('');
        }

        function highlightText(text, query) {
            if (!query.trim()) {
                return escapeHtml(text);
            }

            const escaped = escapeHtml(text);
            const escapedQuery = escapeHtml(query);
            const regex = new RegExp(`(${escapedQuery})`, 'gi');
            return escaped.replace(regex, '<mark class="bg-yellow-500 text-gray-900 px-1 rounded">$1</mark>');
        }

        function performSearch(query) {
            searchQuery = query;
            renderNoteList();

            // 显示/隐藏清除按钮
            if (query.trim()) {
                els.clearSearchBtn.classList.remove('hidden');
            } else {
                els.clearSearchBtn.classList.add('hidden');
            }
        }

        function clearSearch() {
            els.searchInput.value = '';
            performSearch('');
            els.searchInput.focus();
        }

        async function createNote() {
            console.log('Creating note...');
            const note = {
                id: Date.now().toString(36),
                title: '新筆記',
                content: '',
                tags: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            // 保存到 Dexie
            await saveNoteToDb(note);

            // 更新本地数组
            notes.unshift(note);
            renderNoteList();

            // 触发自动备份
            if (autoBackupFileHandle) {
                performAutoBackup().catch(err => console.error('Auto backup failed:', err));
            }

            // 新建笔记时直接进入编辑模式
            currentNoteId = note.id;
            els.noteTitle.value = note.title;
            els.noteContent.value = note.content;
            els.deleteNoteBtn.disabled = false;
            els.toggleModeBtn.disabled = false;
            els.viewModeBtn.disabled = false;
            isMarkmapView = false;
            setEditMode(true);
            renderMarkdown(note.content);
            updateTimestampDisplay(note);

            // 更新数据库状态
            els.dbStatus.textContent = `💾 已載入 ${notes.length} 筆筆記`;
        }

        function selectNote(id) {
            console.log('Selecting note:', id);
            const note = notes.find(n => n.id === id);
            if (!note) return;

            currentNoteId = id;
            els.noteTitle.value = note.title;
            els.noteContent.value = note.content;
            els.deleteNoteBtn.disabled = false;
            els.toggleModeBtn.disabled = false;
            els.viewModeBtn.disabled = false;
            isMarkmapView = false;

            // 默认进入预览模式（Markdown 渲染模式）
            setEditMode(false);

            renderMarkdown(note.content);
            updateTimestampDisplay(note);
            renderNoteTags(note);
            renderNoteList();
        }

        // Tag Management Functions
        function updateTagSuggestions() {
            // Collect all unique tags from all notes
            const allTags = new Set();
            notes.forEach(note => {
                if (note.tags && Array.isArray(note.tags)) {
                    note.tags.forEach(tag => allTags.add(tag));
                }
            });

            // Sort tags alphabetically (a-z)
            const sortedTags = Array.from(allTags).sort((a, b) => a.localeCompare(b));

            // Update datalist options
            const datalist = document.getElementById('tagSuggestions');
            if (datalist) {
                datalist.innerHTML = sortedTags.map(tag =>
                    `<option value="${escapeHtml(tag)}">`
                ).join('');
            }
        }

        function renderNoteTags(note) {
            if (!note) return;

            // 确保 tags 数组存在
            if (!note.tags) {
                note.tags = [];
            }

            els.tagsContainer.innerHTML = note.tags.map(tag => `
                <span class="inline-flex items-center gap-0.5 px-2 py-0.5 bg-blue-600 text-white text-xs rounded-full">
                    ${escapeHtml(tag)}
                    <button class="hover:text-red-300 font-bold ml-0.5" onclick="removeTag('${escapeHtml(tag)}')" title="刪除標籤">×</button>
                </span>
            `).join('');
        }

        async function addTag(tag) {
            if (!currentNoteId) return;

            const note = notes.find(n => n.id === currentNoteId);
            if (!note) return;

            // 清理标签
            tag = tag.trim();
            if (!tag) return;

            // 确保 tags 数组存在
            if (!note.tags) {
                note.tags = [];
            }

            // 检查是否已存在
            if (note.tags.includes(tag)) {
                alert('此標籤已存在！');
                return;
            }

            // 添加标签
            note.tags.push(tag);
            note.updatedAt = new Date().toISOString();

            // 保存到数据库
            await updateNote({ tags: note.tags });

            // 重新渲染
            renderNoteTags(note);
            renderNoteList();
            renderOverviewNotesList(); // 更新总览
            updateTagSuggestions(); // 更新标签建议
        }

        async function removeTag(tag) {
            if (!currentNoteId) return;

            const note = notes.find(n => n.id === currentNoteId);
            if (!note || !note.tags) return;

            // 删除标签
            note.tags = note.tags.filter(t => t !== tag);
            note.updatedAt = new Date().toISOString();

            // 保存到数据库
            await updateNote({ tags: note.tags });

            // 重新渲染
            renderNoteTags(note);
            renderNoteList();
            updateTagSuggestions(); // 更新标签建议
            renderOverviewNotesList(); // 更新总览
        }

        // 使 removeTag 函数全局可用
        window.removeTag = removeTag;

        function setEditMode(editMode) {
            isEditMode = editMode;

            // 如果之前在markmap视图，先退出
            if (isMarkmapView) {
                isMarkmapView = false;
                els.markmapSection.classList.add('hidden');
                els.markmapSection.classList.remove('flex');
                els.viewModeBtn.innerHTML = '🗺️ 思維導圖';
                els.viewModeBtn.className = 'bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg';
            }

            if (isEditMode) {
                // 编辑模式：显示编辑器和Markdown预览
                els.editorSection.classList.remove('hidden');
                els.previewSection.classList.remove('hidden');
                els.resizeHandle.style.display = 'block';
                els.noteTitle.disabled = false;
                els.noteContent.disabled = false;
                els.tagInput.disabled = false;
                els.toggleModeBtn.innerHTML = '✅ 完成';
                els.toggleModeBtn.className = 'bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg';
                els.saveStatus.textContent = '編輯模式';
                applyEditorWidth(); // 应用保存的宽度设置
            } else {
                // Markdown 预览模式：只显示渲染结果
                els.editorSection.classList.add('hidden');
                els.previewSection.classList.remove('hidden');
                els.resizeHandle.style.display = 'none';
                els.noteTitle.disabled = true;
                els.noteContent.disabled = true;
                els.tagInput.disabled = true;
                els.toggleModeBtn.innerHTML = '✏️ 編輯';
                els.toggleModeBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg';
                els.saveStatus.textContent = 'Markdown 模式';
                // 预览模式下恢复为flex-1
                els.previewSection.style.flex = '1';
            }
        }

        function toggleMode() {
            if (!currentNoteId) return;
            setEditMode(!isEditMode);
        }

        async function updateNote(data) {
            const note = notes.find(n => n.id === currentNoteId);
            if (!note) return;

            Object.assign(note, data, { updatedAt: new Date().toISOString() });

            // 保存到 Dexie
            await saveNoteToDb(note);

            // 重新排序
            notes.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
            renderNoteList();
            updateTimestampDisplay(note);

            // 触发自动备份（异步执行，不阻塞保存）
            if (autoBackupFileHandle) {
                performAutoBackup().catch(err => console.error('Auto backup failed:', err));
            }

            // 显示保存状态
            const originalStatus = els.saveStatus.textContent;
            els.saveStatus.textContent = '已儲存 ✓';
            setTimeout(() => {
                els.saveStatus.textContent = isEditMode ? '編輯模式' : 'Markdown 模式';
            }, 2000);
        }

        async function deleteNote() {
            if (!currentNoteId || !confirm('確定要刪除此筆記嗎？')) return;

            // 从 Dexie 删除
            await deleteNoteFromDb(currentNoteId);

            // 从本地数组删除
            notes = notes.filter(n => n.id !== currentNoteId);

            // 触发自动备份
            if (autoBackupFileHandle) {
                performAutoBackup().catch(err => console.error('Auto backup failed:', err));
            }

            currentNoteId = null;
            els.noteTitle.value = '';
            els.noteContent.value = '';
            els.noteTitle.disabled = true;
            els.noteContent.disabled = true;
            els.deleteNoteBtn.disabled = true;
            els.toggleModeBtn.disabled = true;
            els.viewModeBtn.disabled = true;
            els.saveStatus.textContent = '請選擇或建立筆記';
            els.markdownPreview.innerHTML = '<p class="text-gray-500">Markdown 渲染區域</p>';
            isMarkmapView = false;
            els.markmapSection.classList.add('hidden');
            els.markmapSection.classList.remove('flex');
            updateTimestampDisplay(null);

            renderNoteList();

            // 更新数据库状态
            els.dbStatus.textContent = `💾 已載入 ${notes.length} 筆筆記`;
        }

        function renderMarkdown(text) {
            try {
                const html = DOMPurify.sanitize(marked.parse(text || ''));
                els.markdownPreview.innerHTML = html || '<p class="text-gray-500">預覽區域</p>';
            } catch (e) {
                console.error('Markdown error:', e);
            }
        }

        function renderMarkmap(text) {
            if (!markmapTransformer || !text) {
                return;
            }

            try {
                const { root } = markmapTransformer.transform(text);

                // 优化后的配色方案 - 更鲜艳、对比度更高
                const vibrantColors = [
                    '#3b82f6',  // 鲜艳蓝色 - 第一层（根节点）
                    '#10b981',  // 翠绿色 - 第二层
                    '#f59e0b',  // 金黄色 - 第三层
                    '#ec4899',  // 粉红色 - 第四层
                    '#8b5cf6',  // 紫色 - 第五层
                    '#06b6d4',  // 青色 - 第六层
                    '#f97316',  // 橙色 - 第七层
                    '#14b8a6'   // 蓝绿色 - 第八层
                ];

                const markmapOptions = {
                    duration: 500,
                    nodeFont: '500 18px "Microsoft JhengHei", "Microsoft YaHei", -apple-system, BlinkMacSystemFont, sans-serif',
                    paddingX: 25,
                    spacingVertical: 25,
                    spacingHorizontal: 130,
                    // 节点颜色函数
                    color: (node) => {
                        const depth = node.state?.depth || 0;
                        return vibrantColors[depth % vibrantColors.length];
                    },
                    // 自定义样式
                    style: (id) => `
                        #${id} {
                            font-family: "Microsoft JhengHei", "Microsoft YaHei", sans-serif;
                        }
                        /* 整个节点组可点击 */
                        #${id} .markmap-node {
                            cursor: pointer !important;
                        }
                        /* 增大节点圆圈 */
                        #${id} .markmap-node > circle {
                            fill: currentColor;
                            stroke: currentColor;
                            stroke-width: 3px;
                            filter: brightness(1.2) drop-shadow(0 0 12px currentColor);
                            r: 10 !important;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        }
                        #${id} .markmap-node:hover > circle {
                            r: 14 !important;
                            filter: brightness(1.5) drop-shadow(0 0 24px currentColor);
                            stroke-width: 5px;
                        }
                        /* 强化线条可视性 */
                        #${id} .markmap-link {
                            stroke: currentColor;
                            stroke-width: 4px;
                            opacity: 0.75;
                            transition: all 0.3s ease;
                            filter: drop-shadow(0 0 4px currentColor);
                        }
                        #${id} .markmap-link:hover {
                            stroke-width: 6px;
                            opacity: 1;
                            filter: drop-shadow(0 0 8px currentColor);
                        }
                        /* 文字样式 */
                        #${id} text {
                            fill: #f3f4f6;
                            font-weight: 500;
                            paint-order: stroke fill;
                            stroke: #000;
                            stroke-width: 3px;
                            stroke-linecap: round;
                            stroke-linejoin: round;
                            cursor: pointer !important;
                            pointer-events: none !important;
                            user-select: none;
                            transition: all 0.2s ease;
                        }
                        /* 文字悬停效果 */
                        #${id} .markmap-node:hover text {
                            fill: #ffffff;
                            stroke-width: 4px;
                            filter: drop-shadow(0 0 8px currentColor);
                        }
                        /* 为节点添加隐形背景扩大点击区域 */
                        #${id} .markmap-node foreignObject {
                            cursor: pointer !important;
                            pointer-events: none !important;
                        }
                        #${id} .markmap-node foreignObject > div {
                            cursor: pointer !important;
                            padding: 8px 12px;
                            margin: -8px -12px;
                            border-radius: 6px;
                            transition: all 0.2s ease;
                            pointer-events: none !important;
                        }
                        #${id} .markmap-node:hover foreignObject > div {
                            background-color: rgba(255, 255, 255, 0.1);
                            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
                        }
                        /* 代码样式 */
                        #${id} code {
                            background-color: #1e1e1e !important;
                            color: #d4d4d4 !important;
                            padding: 3px 8px !important;
                            border-radius: 4px !important;
                            font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important;
                            font-size: 14px !important;
                            font-weight: 400 !important;
                            border: 1px solid #3a3a3a !important;
                            text-shadow: none !important;
                        }
                        #${id} pre {
                            background-color: #1e1e1e !important;
                            color: #d4d4d4 !important;
                            padding: 12px !important;
                            border-radius: 6px !important;
                            border: 1px solid #3a3a3a !important;
                            margin: 4px 0 !important;
                        }
                        #${id} pre code {
                            background-color: transparent !important;
                            border: none !important;
                            padding: 0 !important;
                        }
                    `
                };

                if (markmapInstance) {
                    markmapInstance.setData(root, markmapOptions);
                } else {
                    markmapInstance = markmap.Markmap.create(els.markmapSvg, markmapOptions, root);
                }

                // 自动适配视图并增强点击区域
                setTimeout(() => {
                    if (markmapInstance && markmapInstance.fit) {
                        markmapInstance.fit();
                    }
                    enhanceNodeClickArea();

                    // 监听SVG点击事件，每次点击后重新增强点击区域
                    els.markmapSvg.addEventListener('click', () => {
                        setTimeout(() => {
                            enhanceNodeClickArea();
                        }, 600); // 等待动画完成
                    });
                }, 300);
            } catch (e) {
                console.error('Markmap error:', e);
            }
        }

        // 添加节点点击区域增强
        function enhanceNodeClickArea() {
            setTimeout(() => {
                const svg = els.markmapSvg;
                const nodes = svg.querySelectorAll('.markmap-node');

                console.log(`找到 ${nodes.length} 个节点`);

                nodes.forEach((node, index) => {
                    // 检查是否已经添加了点击区域
                    if (node.querySelector('.click-area')) {
                        console.log(`节点 ${index} 已有点击区域，跳过`);
                        return;
                    }

                    try {
                        // 获取节点的边界框
                        const bbox = node.getBBox();

                        // 创建一个大的透明矩形作为点击区域
                        const clickArea = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                        clickArea.setAttribute('class', 'click-area');
                        clickArea.setAttribute('x', bbox.x - 20);
                        clickArea.setAttribute('y', bbox.y - 15);
                        clickArea.setAttribute('width', bbox.width + 40);
                        clickArea.setAttribute('height', bbox.height + 30);
                        clickArea.setAttribute('fill', 'transparent');
                        clickArea.setAttribute('cursor', 'pointer');
                        clickArea.setAttribute('rx', '8');
                        clickArea.style.pointerEvents = 'all';

                        // 添加点击事件 - 模拟点击圆圈
                        clickArea.addEventListener('click', (e) => {
                            e.stopPropagation();
                            console.log(`点击了节点 ${index}`);

                            // 找到这个节点的圆圈并触发点击
                            const circle = node.querySelector('circle');
                            if (circle) {
                                console.log('触发圆圈点击');
                                // 创建一个新的点击事件
                                const clickEvent = new MouseEvent('click', {
                                    bubbles: true,
                                    cancelable: true,
                                    view: window
                                });
                                circle.dispatchEvent(clickEvent);
                            } else {
                                console.log('未找到圆圈');
                            }
                        });

                        // 添加悬停效果
                        clickArea.addEventListener('mouseenter', () => {
                            clickArea.setAttribute('fill', 'rgba(255, 255, 255, 0.08)');
                            clickArea.setAttribute('stroke', 'rgba(255, 255, 255, 0.2)');
                            clickArea.setAttribute('stroke-width', '2');
                        });
                        clickArea.addEventListener('mouseleave', () => {
                            clickArea.setAttribute('fill', 'transparent');
                            clickArea.removeAttribute('stroke');
                            clickArea.removeAttribute('stroke-width');
                        });

                        // 将透明矩形插入到节点的最前面（作为背景）
                        node.insertBefore(clickArea, node.firstChild);

                        console.log(`节点 ${index} 添加点击区域成功`);
                    } catch (e) {
                        console.error(`节点 ${index} 添加点击区域失败:`, e);
                    }
                });
            }, 400);
        }

        // Markmap 控制函数
        function expandAllNodes() {
            if (!markmapInstance) return;

            try {
                // 递归展开所有节点
                const expandRecursive = (node) => {
                    if (node.children && node.children.length > 0) {
                        node.payload = node.payload || {};
                        node.payload.fold = 0; // 0 表示展开
                        node.children.forEach(child => expandRecursive(child));
                    }
                };

                // 获取根节点并展开所有子节点
                const state = markmapInstance.state;
                if (state && state.data) {
                    expandRecursive(state.data);
                    markmapInstance.setData(state.data);

                    // 展开后适配视图并增强点击区域
                    setTimeout(() => {
                        if (markmapInstance.fit) {
                            markmapInstance.fit();
                        }
                        enhanceNodeClickArea();
                    }, 300);
                }

                console.log('已展開所有節點');
            } catch (e) {
                console.error('展開節點失敗:', e);
            }
        }

        function collapseAllNodes() {
            if (!markmapInstance) return;

            try {
                // 递归折叠所有节点（保留第一层）
                const collapseRecursive = (node, depth = 0) => {
                    if (node.children && node.children.length > 0) {
                        node.payload = node.payload || {};
                        // 第一层展开，其他层折叠
                        node.payload.fold = depth >= 1 ? 1 : 0; // 1 表示折叠
                        node.children.forEach(child => collapseRecursive(child, depth + 1));
                    }
                };

                // 获取根节点并折叠所有子节点
                const state = markmapInstance.state;
                if (state && state.data) {
                    collapseRecursive(state.data);
                    markmapInstance.setData(state.data);

                    // 折叠后适配视图并增强点击区域
                    setTimeout(() => {
                        if (markmapInstance.fit) {
                            markmapInstance.fit();
                        }
                        enhanceNodeClickArea();
                    }, 300);
                }

                console.log('已摺疊所有節點');
            } catch (e) {
                console.error('摺疊節點失敗:', e);
            }
        }

        function fitMarkmapView() {
            if (!markmapInstance) return;

            try {
                if (markmapInstance.fit) {
                    markmapInstance.fit();
                    console.log('已適配視圖');
                }
            } catch (e) {
                console.error('適配視圖失敗:', e);
            }
        }

        function toggleViewMode() {
            if (!currentNoteId) return;

            isMarkmapView = !isMarkmapView;

            if (isMarkmapView) {
                // 切换到思维导图视图
                els.editorSection.classList.add('hidden');
                els.previewSection.classList.add('hidden');
                els.markmapSection.classList.remove('hidden');
                els.markmapSection.classList.add('flex');
                els.viewModeBtn.innerHTML = '📄 返回閱讀';
                els.viewModeBtn.className = 'bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg';

                // 渲染markmap
                const note = notes.find(n => n.id === currentNoteId);
                if (note) {
                    renderMarkmap(note.content);
                }
            } else {
                // 返回正常视图
                els.markmapSection.classList.add('hidden');
                els.markmapSection.classList.remove('flex');

                if (isEditMode) {
                    els.editorSection.classList.remove('hidden');
                    els.previewSection.classList.remove('hidden');
                } else {
                    els.editorSection.classList.add('hidden');
                    els.previewSection.classList.remove('hidden');
                }

                els.viewModeBtn.innerHTML = '🗺️ 思維導圖';
                els.viewModeBtn.className = 'bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg';
            }
        }

        function debounce(fn, delay) {
            return (...args) => {
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(() => fn(...args), delay);
            };
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDateTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        function formatRelativeTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return '剛剛';
            if (diffMins < 60) return `${diffMins} 分鐘前`;
            if (diffHours < 24) return `${diffHours} 小時前`;
            if (diffDays < 7) return `${diffDays} 天前`;

            return formatDateTime(isoString);
        }

        function updateTimestampDisplay(note) {
            if (!note) {
                els.noteTimestamp.classList.add('hidden');
                return;
            }

            els.createdTime.textContent = `建立時間：${formatDateTime(note.createdAt)}`;
            els.updatedTime.textContent = `最後更新：${formatDateTime(note.updatedAt)}`;
            els.noteTimestamp.classList.remove('hidden');
        }

        // Export/Import Functions
        function exportData() {
            try {
                // 获取所有笔记数据
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    notesCount: notes.length,
                    notes: notes
                };

                // 转换为 JSON 字符串
                const jsonString = JSON.stringify(exportData, null, 2);

                // 创建 Blob 对象
                const blob = new Blob([jsonString], { type: 'application/json' });

                // 创建下载链接
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;

                // 生成文件名（包含日期时间）
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-');
                a.download = `markdown-notes-backup-${dateStr}-${timeStr}.json`;

                // 触发下载
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // 显示成功消息
                const originalStatus = els.saveStatus.textContent;
                els.saveStatus.textContent = `✅ 已匯出 ${notes.length} 筆筆記`;
                setTimeout(() => {
                    els.saveStatus.textContent = originalStatus;
                }, 3000);

                console.log('Data exported successfully:', exportData);
            } catch (error) {
                console.error('Export error:', error);
                alert('匯出失敗：' + error.message);
            }
        }

        function importData() {
            // 触发文件选择
            els.importFileInput.click();
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 验证文件类型
            if (!file.name.endsWith('.json')) {
                alert('請選擇 JSON 格式的檔案');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);

                    // 验证数据格式
                    if (!importedData.notes || !Array.isArray(importedData.notes)) {
                        throw new Error('無效的資料格式：找不到 notes 陣列');
                    }

                    // 询问用户导入方式
                    const choice = confirm(
                        `即將匯入 ${importedData.notesCount || importedData.notes.length} 筆筆記\n\n` +
                        `匯出日期：${importedData.exportDate ? new Date(importedData.exportDate).toLocaleString('zh-TW') : '未知'}\n\n` +
                        `點擊「確定」將覆蓋現有資料\n` +
                        `點擊「取消」將合併資料（保留現有筆記）`
                    );

                    let finalNotes = [];
                    let importedCount = 0;

                    if (choice) {
                        // 覆盖模式：替换所有数据
                        finalNotes = importedData.notes;
                        importedCount = finalNotes.length;
                    } else {
                        // 合并模式：保留现有数据，添加新数据
                        const existingIds = new Set(notes.map(n => n.id));
                        const newNotes = importedData.notes.filter(note => !existingIds.has(note.id));
                        finalNotes = [...notes, ...newNotes];
                        importedCount = newNotes.length;
                    }

                    // 更新 notes 数组
                    notes = finalNotes;

                    // 排序
                    notes.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));

                    // 保存到 Dexie
                    if (choice) {
                        // 覆盖模式：先清空数据库，再批量添加
                        db.notes.clear().then(() => {
                            return db.notes.bulkPut(notes);
                        }).then(() => {
                            renderNoteList();
                            els.dbStatus.textContent = `💾 已載入 ${notes.length} 筆筆記`;
                        });
                    } else {
                        // 合并模式：只添加新的笔记
                        const existingIds = new Set(notes.map(n => n.id));
                        const newNotes = importedData.notes.filter(note => !existingIds.has(note.id));
                        db.notes.bulkPut(newNotes).then(() => {
                            renderNoteList();
                            els.dbStatus.textContent = `💾 已載入 ${notes.length} 筆筆記`;
                        });
                    }

                    renderNoteList();

                    // 触发自动备份
                    if (autoBackupFileHandle) {
                        performAutoBackup().catch(err => console.error('Auto backup failed:', err));
                    }

                    // 清除当前编辑
                    if (currentNoteId && !notes.find(n => n.id === currentNoteId)) {
                        currentNoteId = null;
                        els.noteTitle.value = '';
                        els.noteContent.value = '';
                        els.noteTitle.disabled = true;
                        els.noteContent.disabled = true;
                        els.deleteNoteBtn.disabled = true;
                        els.toggleModeBtn.disabled = true;
                        els.viewModeBtn.disabled = true;
                        els.markdownPreview.innerHTML = '<p class="text-gray-500">Markdown 渲染區域</p>';
                        isMarkmapView = false;
                        els.markmapSection.classList.add('hidden');
                        updateTimestampDisplay(null);
                    }

                    // 显示成功消息
                    const mode = choice ? '覆蓋' : '合併';
                    els.saveStatus.textContent = `✅ 已${mode}匯入 ${importedCount} 筆筆記`;
                    setTimeout(() => {
                        els.saveStatus.textContent = '請選擇或建立筆記';
                    }, 3000);

                    console.log(`Data imported successfully (${mode} mode):`, { importedCount, totalNotes: notes.length });

                } catch (error) {
                    console.error('Import error:', error);
                    alert('匯入失敗：' + error.message);
                }

                // 重置文件输入
                event.target.value = '';
            };

            reader.onerror = () => {
                alert('讀取檔案失敗');
                event.target.value = '';
            };

            reader.readAsText(file);
        }

        // Auto Backup Functions (File System Access API)
        let autoBackupFileHandle = null;

        // 检查 File System Access API 支持
        function isFileSystemAccessSupported() {
            return 'showSaveFilePicker' in window;
        }

        // 设置自动备份文件
        async function setupAutoBackup() {
            if (!isFileSystemAccessSupported()) {
                alert('您的瀏覽器不支援自動備份功能\n\n' +
                      '此功能需要 File System Access API 支援\n' +
                      '請使用最新版本的 Chrome、Edge 或其他支援的瀏覽器');
                return;
            }

            try {
                // 生成默认文件名
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const suggestedName = `markdown-notes-auto-backup-${dateStr}.json`;

                // 请求用户选择或创建备份文件
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: suggestedName,
                    types: [{
                        description: 'JSON Files',
                        accept: { 'application/json': ['.json'] }
                    }]
                });

                // 保存文件句柄到 IndexedDB
                await db.settings.put({ key: 'autoBackupFileHandle', value: fileHandle });
                autoBackupFileHandle = fileHandle;

                // 立即执行一次备份
                await performAutoBackup();

                // 更新UI
                els.autoBackupStatus.textContent = `🔄 自動備份已啟用 → ${fileHandle.name}`;
                els.autoBackupStatus.classList.remove('hidden');
                els.autoBackupStatus.classList.add('text-green-400');
                els.autoBackupBtn.textContent = '💾 變更備份檔案';

                console.log('Auto backup configured:', fileHandle.name);
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Setup auto backup error:', error);
                    alert('設定自動備份失敗：' + error.message);
                }
            }
        }

        // 执行自动备份
        async function performAutoBackup() {
            if (!autoBackupFileHandle) {
                return;
            }

            try {
                // 检查权限
                const permission = await autoBackupFileHandle.queryPermission({ mode: 'readwrite' });
                if (permission !== 'granted') {
                    const requestPermission = await autoBackupFileHandle.requestPermission({ mode: 'readwrite' });
                    if (requestPermission !== 'granted') {
                        console.warn('Auto backup permission denied');
                        return;
                    }
                }

                // 准备备份数据
                const backupData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    notesCount: notes.length,
                    notes: notes,
                    autoBackup: true
                };

                // 写入文件
                const writable = await autoBackupFileHandle.createWritable();
                await writable.write(JSON.stringify(backupData, null, 2));
                await writable.close();

                console.log('Auto backup completed:', autoBackupFileHandle.name);

                // 更新备份状态显示
                const now = new Date();
                const timeStr = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                els.autoBackupStatus.textContent = `🔄 最後備份：${timeStr} → ${autoBackupFileHandle.name}`;
            } catch (error) {
                console.error('Auto backup error:', error);
                // 如果出错，可能是权限问题，清除保存的句柄
                if (error.name === 'NotAllowedError') {
                    await db.settings.delete('autoBackupFileHandle');
                    autoBackupFileHandle = null;
                    els.autoBackupStatus.textContent = '❌ 自動備份失敗（權限不足）';
                    els.autoBackupStatus.classList.remove('text-green-400');
                    els.autoBackupStatus.classList.add('text-red-400');
                }
            }
        }

        // 加载并初始化自动备份
        async function initAutoBackup() {
            if (!isFileSystemAccessSupported()) {
                console.log('File System Access API not supported');
                els.autoBackupBtn.disabled = true;
                els.autoBackupBtn.classList.add('opacity-50', 'cursor-not-allowed');
                els.autoBackupBtn.title = '您的瀏覽器不支援此功能';
                return;
            }

            try {
                // 从 IndexedDB 加载保存的文件句柄
                const setting = await db.settings.get('autoBackupFileHandle');
                if (setting && setting.value) {
                    autoBackupFileHandle = setting.value;

                    // 验证文件句柄是否仍然有效
                    try {
                        const permission = await autoBackupFileHandle.queryPermission({ mode: 'readwrite' });
                        if (permission === 'granted' || permission === 'prompt') {
                            // 更新UI
                            els.autoBackupStatus.textContent = `🔄 自動備份已啟用 → ${autoBackupFileHandle.name}`;
                            els.autoBackupStatus.classList.remove('hidden');
                            els.autoBackupStatus.classList.add('text-green-400');
                            els.autoBackupBtn.textContent = '💾 變更備份檔案';

                            // 执行自动备份
                            await performAutoBackup();
                        }
                    } catch (e) {
                        // 文件句柄无效，清除
                        console.warn('Saved file handle is invalid:', e);
                        await db.settings.delete('autoBackupFileHandle');
                        autoBackupFileHandle = null;
                    }
                }
            } catch (error) {
                console.error('Init auto backup error:', error);
            }
        }

        // Help Modal Functions
        function openHelpModal() {
            els.helpModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // 禁止背景滚动
        }

        function closeHelpModal() {
            els.helpModal.classList.add('hidden');
            document.body.style.overflow = ''; // 恢复滚动
        }

        // Overview Modal Functions
        let overviewSearchQuery = '';
        let currentSortOption = 'updatedAt-desc';
        let currentTagFilter = '';

        function openOverviewModal() {
            els.overviewModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            populateTagFilter();
            renderOverviewNotesList();
        }

        function populateTagFilter() {
            // 收集所有标签
            const allTags = new Set();
            notes.forEach(note => {
                if (note.tags && Array.isArray(note.tags)) {
                    note.tags.forEach(tag => allTags.add(tag));
                }
            });

            // 填充标签选择器
            const tagsArray = Array.from(allTags).sort();
            els.tagFilter.innerHTML = `
                <option value="">全部標籤${tagsArray.length > 0 ? ` (${tagsArray.length})` : ''}</option>
                ${tagsArray.map(tag => `
                    <option value="${escapeHtml(tag)}">${escapeHtml(tag)}</option>
                `).join('')}
            `;

            // 重置当前筛选
            els.tagFilter.value = currentTagFilter || '';
        }

        function closeOverviewModal() {
            els.overviewModal.classList.add('hidden');
            document.body.style.overflow = '';
            overviewSearchQuery = '';
            els.overviewSearchInput.value = '';
            els.clearOverviewSearchBtn.classList.add('hidden');
            els.overviewSearchStats.classList.add('hidden');
        }

        function sortNotes(notesList, sortOption) {
            const sorted = [...notesList];
            const [field, order] = sortOption.split('-');

            sorted.sort((a, b) => {
                let valA, valB;

                if (field === 'title') {
                    valA = (a.title || '無標題').toLowerCase();
                    valB = (b.title || '無標題').toLowerCase();
                } else if (field === 'createdAt') {
                    valA = new Date(a.createdAt);
                    valB = new Date(b.createdAt);
                } else { // updatedAt
                    valA = new Date(a.updatedAt);
                    valB = new Date(b.updatedAt);
                }

                if (order === 'asc') {
                    return valA > valB ? 1 : valA < valB ? -1 : 0;
                } else {
                    return valA < valB ? 1 : valA > valB ? -1 : 0;
                }
            });

            return sorted;
        }

        function filterOverviewNotes(notesList, query) {
            let filtered = notesList;

            // 按搜索关键字过滤
            if (query.trim()) {
                const lowerQuery = query.toLowerCase();
                filtered = filtered.filter(note => {
                    const title = (note.title || '無標題').toLowerCase();
                    return title.includes(lowerQuery);
                });
            }

            // 按标签过滤
            if (currentTagFilter) {
                filtered = filtered.filter(note => {
                    return note.tags && note.tags.includes(currentTagFilter);
                });
            }

            return filtered;
        }

        function highlightText(text, query) {
            if (!query.trim()) return text;

            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<mark class="bg-yellow-400 text-black">$1</mark>');
        }

        function renderOverviewNotesList() {
            // Filter notes
            let filteredNotes = filterOverviewNotes(notes, overviewSearchQuery);

            // Sort notes
            const sortedNotes = sortNotes(filteredNotes, currentSortOption);

            // Update stats
            els.totalNotesCount.textContent = notes.length;

            if (overviewSearchQuery.trim()) {
                els.overviewSearchStats.classList.remove('hidden');
                els.overviewSearchCount.textContent = filteredNotes.length;
            } else {
                els.overviewSearchStats.classList.add('hidden');
            }

            // Render notes list
            if (sortedNotes.length === 0) {
                els.overviewNotesList.innerHTML = `
                    <div class="text-center text-gray-500 py-12">
                        <p class="text-lg">📝</p>
                        <p class="mt-2">${overviewSearchQuery.trim() ? '沒有找到符合的筆記' : '尚無筆記'}</p>
                    </div>
                `;
                return;
            }

            const notesHTML = sortedNotes.map(note => {
                const title = note.title || '無標題';
                const highlightedTitle = highlightText(title, overviewSearchQuery);
                const createdDate = new Date(note.createdAt).toLocaleDateString('zh-TW');
                const updatedDate = new Date(note.updatedAt).toLocaleDateString('zh-TW');
                const isCurrentNote = note.id === currentNoteId;
                const tags = note.tags || [];
                const tagsHTML = tags.length > 0 ? `
                    <div class="flex flex-wrap gap-1 mt-1">
                        ${tags.map(tag => `
                            <span class="inline-block px-1.5 py-0.5 bg-blue-600 text-[10px] text-white rounded-full">
                                ${escapeHtml(tag)}
                            </span>
                        `).join('')}
                    </div>
                ` : '';

                return `
                    <div class="bg-gray-700 rounded-lg p-2.5 mb-2 transition-colors ${isCurrentNote ? 'ring-2 ring-blue-500' : ''} group">
                        <div class="flex justify-between items-start gap-2">
                            <div class="flex-1 min-w-0">
                                <div class="flex flex-wrap items-baseline gap-x-2 gap-y-1 mb-1">
                                    <h3 class="text-base font-semibold text-gray-100 cursor-pointer hover:text-blue-400 transition-colors group-hover:underline"
                                        data-note-id="${note.id}"
                                        title="點擊開啟筆記">
                                        ${highlightedTitle}
                                    </h3>
                                    <div class="flex flex-wrap items-center gap-x-2 gap-y-0.5 text-xs text-gray-400">
                                        <span class="whitespace-nowrap">創建 ${createdDate}</span>
                                        <span class="whitespace-nowrap">更新 ${updatedDate}</span>
                                    </div>
                                </div>
                                ${tagsHTML}
                            </div>
                            ${isCurrentNote ? '<div class="text-blue-400 text-xs font-semibold whitespace-nowrap">✓ 當前</div>' : ''}
                        </div>
                    </div>
                `;
            }).join('');

            els.overviewNotesList.innerHTML = notesHTML;

            // Add click event listeners to note titles
            els.overviewNotesList.querySelectorAll('h3[data-note-id]').forEach(titleEl => {
                titleEl.addEventListener('click', (e) => {
                    e.stopPropagation(); // 防止事件冒泡
                    const noteId = titleEl.dataset.noteId;
                    selectNote(noteId);
                    closeOverviewModal();
                });
            });
        }

        function performOverviewSearch(query) {
            overviewSearchQuery = query;

            if (query.trim()) {
                els.clearOverviewSearchBtn.classList.remove('hidden');
            } else {
                els.clearOverviewSearchBtn.classList.add('hidden');
            }

            renderOverviewNotesList();
        }

        function clearOverviewSearch() {
            els.overviewSearchInput.value = '';
            overviewSearchQuery = '';
            els.clearOverviewSearchBtn.classList.add('hidden');
            renderOverviewNotesList();
        }

        // Fullscreen Functions
        function toggleFullscreen(section, btn) {
            const isFullscreen = section.classList.contains('fullscreen-mode');

            if (isFullscreen) {
                // 退出全屏
                section.classList.remove('fullscreen-mode');
                btn.innerHTML = '⛶';
                btn.title = '全屏查看';
                document.body.style.overflow = ''; // 恢复滚动

                // 如果是思维导图，需要重新适配视图
                if (section === els.markmapSection && markmapInstance) {
                    setTimeout(() => {
                        if (markmapInstance && markmapInstance.fit) {
                            markmapInstance.fit();
                        }
                    }, 150);
                }
            } else {
                // 进入全屏
                section.classList.add('fullscreen-mode');
                btn.innerHTML = '⛉';
                btn.title = '退出全屏 (ESC)';
                document.body.style.overflow = 'hidden'; // 禁止背景滚动

                // 如果是思维导图，需要重新适配视图
                if (section === els.markmapSection && markmapInstance) {
                    setTimeout(() => {
                        if (markmapInstance && markmapInstance.fit) {
                            markmapInstance.fit();
                        }
                    }, 150);
                }
            }
        }

        function exitAllFullscreen() {
            // 退出所有全屏
            if (els.previewSection.classList.contains('fullscreen-mode')) {
                toggleFullscreen(els.previewSection, els.previewFullscreenBtn);
            }
            if (els.markmapSection.classList.contains('fullscreen-mode')) {
                toggleFullscreen(els.markmapSection, els.markmapFullscreenBtn);
            }
        }

        // Zoom Functions
        function loadZoomScale() {
            // 从localStorage加载缩放比例
            const savedZoom = localStorage.getItem('markdownZoomScale');
            if (savedZoom) {
                zoomScale = parseFloat(savedZoom);
                applyZoom();
            }
        }

        function saveZoomScale() {
            // 保存缩放比例到localStorage
            localStorage.setItem('markdownZoomScale', zoomScale.toString());
        }

        function applyZoom() {
            // 应用缩放和平移到Markdown预览区域
            els.markdownPreview.style.transform = `translate(${panX}px, ${panY}px) scale(${zoomScale})`;
            els.zoomLevel.textContent = `${Math.round(zoomScale * 100)}%`;

            // 更新cursor样式
            if (zoomScale > 1.0) {
                els.markdownPreview.classList.add('zoomed');
            } else {
                els.markdownPreview.classList.remove('zoomed');
                // 重置平移
                panX = 0;
                panY = 0;
            }
        }

        function zoomIn() {
            // 放大，最大200%
            if (zoomScale < 2.0) {
                zoomScale = Math.min(2.0, zoomScale + 0.1);
                applyZoom();
                saveZoomScale();
            }
        }

        function zoomOut() {
            // 缩小，最小50%
            if (zoomScale > 0.5) {
                zoomScale = Math.max(0.5, zoomScale - 0.1);
                applyZoom();
                saveZoomScale();
            }
        }

        function zoomReset() {
            // 重置为100%
            zoomScale = 1.0;
            panX = 0;
            panY = 0;
            applyZoom();
            saveZoomScale();
        }

        // Wheel Zoom Function
        function handleWheelZoom(e) {
            // 只在按住Ctrl/Cmd时才缩放
            if (e.ctrlKey || e.metaKey) {
                e.preventDefault();

                // 获取鼠标位置相对于预览区域的坐标
                const rect = els.markdownPreview.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                // 计算缩放前的内容坐标
                const contentX = (mouseX - panX) / zoomScale;
                const contentY = (mouseY - panY) / zoomScale;

                // 根据滚轮方向调整缩放
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                const newScale = Math.min(2.0, Math.max(0.5, zoomScale + delta));

                if (newScale !== zoomScale) {
                    zoomScale = newScale;

                    // 调整平移以保持鼠标位置不变
                    if (zoomScale > 1.0) {
                        panX = mouseX - contentX * zoomScale;
                        panY = mouseY - contentY * zoomScale;
                    }

                    applyZoom();
                    saveZoomScale();
                }
            }
        }

        // Drag Functions
        function startDrag(e) {
            // 只在缩放时才允许拖动
            if (zoomScale > 1.0) {
                isDragging = true;
                dragStartX = e.clientX - panX;
                dragStartY = e.clientY - panY;
                els.markdownPreview.classList.add('dragging');
            }
        }

        function doDrag(e) {
            if (isDragging) {
                e.preventDefault();
                panX = e.clientX - dragStartX;
                panY = e.clientY - dragStartY;
                applyZoom();
            }
        }

        function endDrag() {
            if (isDragging) {
                isDragging = false;
                els.markdownPreview.classList.remove('dragging');
            }
        }

        // Resize Handle Functions
        function loadEditorWidth() {
            const saved = localStorage.getItem('editor-width');
            if (saved) {
                editorWidth = parseFloat(saved);
                applyEditorWidth();
            }
        }

        function saveEditorWidth() {
            localStorage.setItem('editor-width', editorWidth.toString());
        }

        function applyEditorWidth() {
            // 确保宽度在合理范围内 (20% - 80%)
            editorWidth = Math.max(20, Math.min(80, editorWidth));

            els.editorSection.style.flex = `0 0 ${editorWidth}%`;
            els.previewSection.style.flex = `0 0 ${100 - editorWidth}%`;
        }

        function initResizeHandle() {
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;

            els.resizeHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                startWidth = editorWidth;
                document.body.classList.add('resizing');
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const container = els.editorSection.parentElement;
                const containerWidth = container.offsetWidth;
                const deltaX = e.clientX - startX;
                const deltaPercent = (deltaX / containerWidth) * 100;

                editorWidth = startWidth + deltaPercent;
                applyEditorWidth();
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    document.body.classList.remove('resizing');
                    saveEditorWidth();
                }
            });

            // 双击重置为50/50
            els.resizeHandle.addEventListener('dblclick', () => {
                editorWidth = 50;
                applyEditorWidth();
                saveEditorWidth();
            });
        }

        // Make selectNote global
        window.selectNote = selectNote;

        // Event listeners
        els.newNoteBtn.addEventListener('click', createNote);
        els.deleteNoteBtn.addEventListener('click', deleteNote);
        els.toggleModeBtn.addEventListener('click', toggleMode);
        els.viewModeBtn.addEventListener('click', toggleViewMode);

        // Export/Import events
        els.exportBtn.addEventListener('click', exportData);
        els.importBtn.addEventListener('click', importData);
        els.importFileInput.addEventListener('change', handleImportFile);

        // Auto Backup events
        els.autoBackupBtn.addEventListener('click', setupAutoBackup);

        // Help Modal events
        els.helpBtn.addEventListener('click', openHelpModal);
        els.closeHelpBtn.addEventListener('click', closeHelpModal);
        els.closeHelpBtn2.addEventListener('click', closeHelpModal);

        // 点击模态框背景关闭
        els.helpModal.addEventListener('click', (e) => {
            if (e.target === els.helpModal) {
                closeHelpModal();
            }
        });

        // Overview Modal events
        els.overviewBtn.addEventListener('click', openOverviewModal);
        els.closeOverviewBtn.addEventListener('click', closeOverviewModal);
        els.closeOverviewBtn2.addEventListener('click', closeOverviewModal);

        // 点击模态框背景关闭
        els.overviewModal.addEventListener('click', (e) => {
            if (e.target === els.overviewModal) {
                closeOverviewModal();
            }
        });

        // Overview search and sort
        els.overviewSearchInput.addEventListener('input', (e) => {
            performOverviewSearch(e.target.value);
        });

        els.clearOverviewSearchBtn.addEventListener('click', clearOverviewSearch);

        els.sortSelect.addEventListener('change', (e) => {
            currentSortOption = e.target.value;
            renderOverviewNotesList();
        });

        els.tagFilter.addEventListener('change', (e) => {
            currentTagFilter = e.target.value;
            renderOverviewNotesList();
        });

        // Fullscreen events
        els.previewFullscreenBtn.addEventListener('click', () => {
            toggleFullscreen(els.previewSection, els.previewFullscreenBtn);
        });

        els.markmapFullscreenBtn.addEventListener('click', () => {
            toggleFullscreen(els.markmapSection, els.markmapFullscreenBtn);
        });

        // Zoom events
        els.zoomInBtn.addEventListener('click', zoomIn);
        els.zoomOutBtn.addEventListener('click', zoomOut);
        els.zoomResetBtn.addEventListener('click', zoomReset);

        // Wheel zoom event
        els.markdownPreview.addEventListener('wheel', handleWheelZoom, { passive: false });

        // Drag events
        els.markdownPreview.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', doDrag);
        document.addEventListener('mouseup', endDrag);

        // Markmap 控制按钮事件
        els.expandAllBtn.addEventListener('click', expandAllNodes);
        els.collapseAllBtn.addEventListener('click', collapseAllNodes);
        els.fitViewBtn.addEventListener('click', fitMarkmapView);

        // ESC 键关闭模态框或退出全屏，Ctrl/Cmd + Plus/Minus 缩放
        document.addEventListener('keydown', (e) => {
            // 缩放快捷键 (Ctrl/Cmd + Plus/Minus/0)
            if ((e.ctrlKey || e.metaKey) && !e.shiftKey) {
                if (e.key === '+' || e.key === '=') {
                    e.preventDefault();
                    zoomIn();
                    return;
                } else if (e.key === '-' || e.key === '_') {
                    e.preventDefault();
                    zoomOut();
                    return;
                } else if (e.key === '0') {
                    e.preventDefault();
                    zoomReset();
                    return;
                }
            }

            if (e.key === 'Escape') {
                // 优先关闭帮助模态框
                if (!els.helpModal.classList.contains('hidden')) {
                    closeHelpModal();
                }
                // 然后关闭总览模态框
                else if (!els.overviewModal.classList.contains('hidden')) {
                    closeOverviewModal();
                }
                // 然后退出全屏
                else if (els.previewSection.classList.contains('fullscreen-mode') ||
                         els.markmapSection.classList.contains('fullscreen-mode')) {
                    exitAllFullscreen();
                }
                // 最后清除搜索
                else if (els.searchInput.value) {
                    clearSearch();
                }
            }
        });

        // Search events
        els.searchInput.addEventListener('input', (e) => {
            performSearch(e.target.value);
        });

        els.clearSearchBtn.addEventListener('click', clearSearch);

        const debouncedSave = debounce((data) => updateNote(data), 1500);

        els.noteTitle.addEventListener('input', (e) => {
            debouncedSave({ title: e.target.value });
            renderNoteList();
        });

        els.noteContent.addEventListener('input', (e) => {
            debouncedSave({ content: e.target.value });
            renderMarkdown(e.target.value);
        });

        // Tag input events
        els.tagInput.addEventListener('focus', () => {
            updateTagSuggestions(); // 聚焦时更新标签建议
        });

        els.tagInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const tag = els.tagInput.value.trim();
                if (tag) {
                    await addTag(tag);
                    els.tagInput.value = '';
                }
            }
        });

        // Initialize
        (async () => {
            await loadNotes();
            loadEditorWidth();
            loadZoomScale(); // 加载缩放比例
            initResizeHandle();
            await initAutoBackup(); // 初始化自动备份（如果已设置，会自动执行备份）
            console.log('App ready!');
        })();
    </script>
</body>
</html>
