<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Note Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        .note-list-item { transition: background-color 0.2s; }
        .note-list-item:hover { background-color: rgba(59, 130, 246, 0.2); }
        .note-list-item.active { background-color: rgba(59, 130, 246, 0.3); border-left: 4px solid #3b82f6; }
        .markdown-preview { line-height: 1.6; }
        .markdown-preview h1 { font-size: 2em; font-weight: bold; margin: 0.67em 0; }
        .markdown-preview h2 { font-size: 1.5em; font-weight: bold; margin: 0.83em 0; }
        .markdown-preview h3 { font-size: 1.17em; font-weight: bold; margin: 1em 0; }
        .markdown-preview p { margin-bottom: 1em; }
        .markdown-preview ul, .markdown-preview ol { margin-left: 2em; margin-bottom: 1em; }
        .markdown-preview code { background-color: #374151; color: #e5e7eb; padding: 0.2em 0.4em; border-radius: 3px; font-family: monospace; }
        .markdown-preview pre { background-color: #374151; padding: 1em; border-radius: 5px; overflow-x: auto; margin-bottom: 1em; }
        .markdown-preview pre code { background-color: transparent; padding: 0; }
        .markdown-preview blockquote { border-left: 4px solid #4b5563; padding-left: 1em; margin: 0 0 1em 0; color: #9ca3af; }
        .markdown-preview table { border-collapse: collapse; width: 100%; margin-bottom: 1em; }
        .markdown-preview table th { background-color: #374151; color: #e5e7eb; font-weight: bold; padding: 0.75em; text-align: left; border: 1px solid #4b5563; }
        .markdown-preview table td { padding: 0.75em; border: 1px solid #4b5563; }
        .markdown-preview table tr:nth-child(even) { background-color: rgba(55, 65, 81, 0.3); }
        .markdown-preview table tr:hover { background-color: rgba(59, 130, 246, 0.1); }
        .markdown-preview a { color: #60a5fa; text-decoration: underline; }
        .markdown-preview a:hover { color: #93c5fd; }
        .markdown-preview hr { border: none; border-top: 1px solid #4b5563; margin: 1.5em 0; }
        .markdown-preview img { max-width: 100%; height: auto; border-radius: 5px; margin: 1em 0; }
        .markdown-preview del { text-decoration: line-through; opacity: 0.7; }
        .markdown-preview strong { font-weight: bold; }
        .markdown-preview em { font-style: italic; }
        .markdown-preview ul.contains-task-list { list-style: none; margin-left: 0; padding-left: 0; }
        .markdown-preview input[type="checkbox"] { margin-right: 0.5em; cursor: pointer; }
        .markdown-preview input[type="checkbox"]:disabled { cursor: default; }
        .markdown-preview sup { vertical-align: super; font-size: smaller; }
        .markdown-preview sub { vertical-align: sub; font-size: smaller; }
        #noteTitle:disabled { opacity: 1; cursor: default; }
    </style>
</head>
<body class="bg-gray-900">
    <div class="h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-gray-800 text-white p-4 shadow-lg">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-bold">ğŸ“ Markdown Note Cloud</h1>
                <div class="flex items-center gap-3">
                    <button id="helpBtn" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-sm font-semibold">
                        â“ ä½¿ç”¨èªªæ˜
                    </button>
                    <span class="text-sm text-gray-300">æœ¬åœ°å„²å­˜æ¨¡å¼</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Sidebar -->
            <aside class="w-80 bg-gray-800 border-r border-gray-700 flex flex-col">
                <div class="p-4 border-b border-gray-700">
                    <button id="newNoteBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg mb-2">
                        â• æ–°å¢ç­†è¨˜
                    </button>
                    <div class="flex gap-2">
                        <button id="exportBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg text-sm">
                            ğŸ“¤ åŒ¯å‡º
                        </button>
                        <button id="importBtn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-3 rounded-lg text-sm">
                            ğŸ“¥ åŒ¯å…¥
                        </button>
                    </div>
                    <input type="file" id="importFileInput" accept=".json" class="hidden">
                </div>
                <div class="p-4 border-b border-gray-700">
                    <div class="relative">
                        <input
                            id="searchInput"
                            type="text"
                            placeholder="ğŸ” æœå°‹ç­†è¨˜..."
                            class="w-full bg-gray-700 text-gray-100 placeholder-gray-400 rounded-lg py-2 px-4 outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="clearSearchBtn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-200 hidden">
                            âœ•
                        </button>
                    </div>
                    <div id="searchStats" class="mt-2 text-xs text-gray-400 hidden">
                        æ‰¾åˆ° <span id="searchCount">0</span> ç­†çµæœ
                    </div>
                </div>
                <div id="noteList" class="flex-1 overflow-y-auto"></div>
            </aside>

            <!-- Editor -->
            <main class="flex-1 flex flex-col bg-gray-800">
                <div class="p-4 border-b border-gray-700">
                    <input id="noteTitle" type="text" placeholder="è¼¸å…¥ç­†è¨˜æ¨™é¡Œ..."
                           class="w-full text-2xl font-bold outline-none bg-transparent text-gray-100 placeholder-gray-500" disabled>
                    <div id="noteTimestamp" class="mt-2 text-xs text-gray-500 hidden">
                        <span id="createdTime"></span>
                        <span class="mx-2">â€¢</span>
                        <span id="updatedTime"></span>
                    </div>
                </div>
                <div class="flex-1 flex overflow-hidden">
                    <div id="editorSection" class="flex-1 flex flex-col border-r border-gray-700">
                        <div class="p-2 bg-gray-900 border-b border-gray-700">
                            <span class="text-sm font-semibold text-gray-300">âœï¸ ç·¨è¼¯å™¨</span>
                        </div>
                        <textarea id="noteContent" placeholder="åœ¨æ­¤è¼¸å…¥ Markdown å…§å®¹..."
                                  class="flex-1 p-4 outline-none resize-none font-mono text-sm bg-gray-800 text-gray-100 placeholder-gray-500" disabled></textarea>
                    </div>
                    <div id="previewSection" class="flex-1 flex flex-col">
                        <div class="p-2 bg-gray-900 border-b border-gray-700">
                            <span class="text-sm font-semibold text-gray-300">ğŸ“„ Markdown</span>
                        </div>
                        <div id="markdownPreview" class="flex-1 p-4 overflow-y-auto markdown-preview text-gray-100">
                            <p class="text-gray-500">Markdown æ¸²æŸ“å€åŸŸ</p>
                        </div>
                    </div>
                </div>
                <div class="p-4 border-t border-gray-700 flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <span id="saveStatus" class="text-sm text-gray-400">è«‹é¸æ“‡æˆ–å»ºç«‹ç­†è¨˜</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <button id="toggleModeBtn" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>
                            âœï¸ ç·¨è¼¯
                        </button>
                        <button id="deleteNoteBtn" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>
                            ğŸ—‘ï¸ åˆªé™¤ç­†è¨˜
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <!-- Help Modal -->
        <div id="helpModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
                <!-- Modal Header -->
                <div class="sticky top-0 bg-gray-800 border-b border-gray-700 p-6 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-100">ğŸ“– ä½¿ç”¨èªªæ˜</h2>
                    <button id="closeHelpBtn" class="text-gray-400 hover:text-gray-200 text-3xl leading-none">
                        Ã—
                    </button>
                </div>

                <!-- Modal Content -->
                <div class="p-6 text-gray-200 space-y-6">
                    <!-- åŠŸèƒ½ä»‹ç´¹ -->
                    <section>
                        <h3 class="text-xl font-bold text-blue-400 mb-3">âœ¨ åŠŸèƒ½ç‰¹è‰²</h3>
                        <ul class="list-disc list-inside space-y-2 text-gray-300">
                            <li>ğŸ“„ æ”¯æ´å®Œæ•´ GitHub Flavored Markdown (GFM) èªæ³•</li>
                            <li>ğŸ¨ ç¨‹å¼ç¢¼èªæ³•é«˜äº®ï¼šæ”¯æ´ 180+ ç¨®ç¨‹å¼èªè¨€</li>
                            <li>âœ… æ”¯æ´ä»»å‹™åˆ—è¡¨ã€è¡¨æ ¼ã€åˆªé™¤ç·šç­‰ GFM æ“´å±•èªæ³•</li>
                            <li>âœï¸ é›™æ¨¡å¼åˆ‡æ›ï¼šMarkdown é–±è®€æ¨¡å¼ â‡„ å³æ™‚ç·¨è¼¯æ¨¡å¼</li>
                            <li>ğŸ” å…¨æ–‡æª¢ç´¢ï¼šå³æ™‚æœå°‹æ¨™é¡Œå’Œå…§å®¹ï¼Œé—œéµå­—é«˜äº®é¡¯ç¤º</li>
                            <li>ğŸ“¤ğŸ“¥ è³‡æ–™åŒ¯å‡º/åŒ¯å…¥ï¼šæ”¯æ´å‚™ä»½å’Œé‚„åŸæ‰€æœ‰ç­†è¨˜</li>
                            <li>ğŸ“… æ™‚é–“æ¨™è¨˜ï¼šè‡ªå‹•è¨˜éŒ„å»ºç«‹æ™‚é–“èˆ‡æœ€å¾Œæ›´æ–°æ™‚é–“</li>
                            <li>ğŸ’¾ è‡ªå‹•å„²å­˜ï¼šç·¨è¼¯å¾Œ 1.5 ç§’è‡ªå‹•å„²å­˜</li>
                            <li>ğŸŒ“ æ·±è‰²æ¨¡å¼ï¼šè­·çœ¼æ·±è‰²ç•Œé¢è¨­è¨ˆ</li>
                            <li>ğŸ” å®‰å…¨ä¿è­·ï¼šé˜²æ­¢ XSS æ”»æ“Š</li>
                        </ul>
                    </section>

                    <!-- åŸºæœ¬æ“ä½œ -->
                    <section>
                        <h3 class="text-xl font-bold text-green-400 mb-3">ğŸ“ åŸºæœ¬æ“ä½œ</h3>

                        <div class="space-y-4">
                            <div>
                                <h4 class="font-semibold text-gray-100 mb-2">1ï¸âƒ£ å»ºç«‹ç­†è¨˜</h4>
                                <p class="text-gray-300 ml-4">é»æ“Šå·¦å´é¢æ¿çš„ã€Œâ• æ–°å¢ç­†è¨˜ã€æŒ‰éˆ•ï¼Œç³»çµ±æœƒè‡ªå‹•å»ºç«‹ä¸€ç¯‡æ–°ç­†è¨˜ä¸¦é€²å…¥ç·¨è¼¯æ¨¡å¼ã€‚</p>
                            </div>

                            <div>
                                <h4 class="font-semibold text-gray-100 mb-2">2ï¸âƒ£ ç·¨è¼¯ç­†è¨˜</h4>
                                <p class="text-gray-300 ml-4">
                                    â€¢ é»æ“Šç­†è¨˜åˆ—è¡¨ä¸­çš„ä»»ä¸€ç­†è¨˜ï¼Œé è¨­æœƒé€²å…¥ <strong>Markdown æ¨¡å¼</strong>ï¼ˆç´”é–±è®€ï¼‰<br>
                                    â€¢ é»æ“Šå³ä¸‹è§’ã€Œâœï¸ ç·¨è¼¯ã€æŒ‰éˆ•é€²å…¥ç·¨è¼¯æ¨¡å¼<br>
                                    â€¢ åœ¨ç·¨è¼¯æ¨¡å¼ä¸‹ï¼Œå·¦å´ç‚ºç·¨è¼¯å™¨ï¼Œå³å´å³æ™‚é è¦½ Markdown æ¸²æŸ“çµæœ<br>
                                    â€¢ å®Œæˆç·¨è¼¯å¾Œé»æ“Šã€Œâœ… å®Œæˆã€è¿”å› Markdown æ¨¡å¼
                                </p>
                            </div>

                            <div>
                                <h4 class="font-semibold text-gray-100 mb-2">3ï¸âƒ£ åˆªé™¤ç­†è¨˜</h4>
                                <p class="text-gray-300 ml-4">é¸æ“‡ç­†è¨˜å¾Œï¼Œé»æ“Šå³ä¸‹è§’ã€ŒğŸ—‘ï¸ åˆªé™¤ç­†è¨˜ã€æŒ‰éˆ•ï¼Œç¢ºèªå¾Œå³å¯åˆªé™¤ã€‚</p>
                            </div>
                        </div>
                    </section>

                    <!-- æœå°‹åŠŸèƒ½ -->
                    <section>
                        <h3 class="text-xl font-bold text-purple-400 mb-3">ğŸ” æœå°‹åŠŸèƒ½</h3>
                        <div class="text-gray-300 ml-4 space-y-2">
                            <p>â€¢ åœ¨å·¦å´é¢æ¿çš„æœå°‹æ¡†è¼¸å…¥é—œéµå­—</p>
                            <p>â€¢ ç³»çµ±æœƒå³æ™‚æœå°‹ç­†è¨˜æ¨™é¡Œå’Œå…§å®¹</p>
                            <p>â€¢ æœå°‹çµæœæœƒä»¥é»ƒè‰²é«˜äº®é¡¯ç¤ºé—œéµå­—</p>
                            <p>â€¢ é¡¯ç¤ºæ‰¾åˆ°çš„ç­†è¨˜æ•¸é‡çµ±è¨ˆ</p>
                            <p>â€¢ é»æ“Šã€Œâœ•ã€æˆ–æŒ‰ ESC éµæ¸…é™¤æœå°‹</p>
                        </div>
                    </section>

                    <!-- åŒ¯å‡ºåŒ¯å…¥ -->
                    <section>
                        <h3 class="text-xl font-bold text-yellow-400 mb-3">ğŸ’¾ è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h3>

                        <div class="space-y-4">
                            <div>
                                <h4 class="font-semibold text-gray-100 mb-2">ğŸ“¤ åŒ¯å‡ºè³‡æ–™</h4>
                                <p class="text-gray-300 ml-4">
                                    é»æ“Šå·¦å´é¢æ¿çš„ã€ŒğŸ“¤ åŒ¯å‡ºã€æŒ‰éˆ•ï¼Œç³»çµ±æœƒå°‡æ‰€æœ‰ç­†è¨˜åŒ¯å‡ºç‚º JSON æ ¼å¼æª”æ¡ˆã€‚<br>
                                    æª”æ¡ˆåç¨±æ ¼å¼ï¼š<code class="bg-gray-700 px-2 py-1 rounded">markdown-notes-backup-YYYY-MM-DD-HH-MM-SS.json</code>
                                </p>
                            </div>

                            <div>
                                <h4 class="font-semibold text-gray-100 mb-2">ğŸ“¥ åŒ¯å…¥è³‡æ–™</h4>
                                <p class="text-gray-300 ml-4">
                                    é»æ“Šå·¦å´é¢æ¿çš„ã€ŒğŸ“¥ åŒ¯å…¥ã€æŒ‰éˆ•ï¼Œé¸æ“‡ä¹‹å‰åŒ¯å‡ºçš„ JSON æª”æ¡ˆã€‚<br>
                                    ç³»çµ±æœƒé¡¯ç¤ºåŒ¯å…¥é è¦½è³‡è¨Šï¼Œä¸¦æä¾›å…©ç¨®åŒ¯å…¥æ¨¡å¼ï¼š<br>
                                    <span class="block mt-2">
                                        â€¢ <strong>è¦†è“‹æ¨¡å¼</strong>ï¼ˆé»æ“Šã€Œç¢ºå®šã€ï¼‰ï¼šåˆªé™¤ç¾æœ‰æ‰€æœ‰ç­†è¨˜ï¼Œå®Œå…¨æ›¿æ›ç‚ºåŒ¯å…¥çš„è³‡æ–™<br>
                                        â€¢ <strong>åˆä½µæ¨¡å¼</strong>ï¼ˆé»æ“Šã€Œå–æ¶ˆã€ï¼‰ï¼šä¿ç•™ç¾æœ‰ç­†è¨˜ï¼Œåªæ–°å¢ä¸é‡è¤‡çš„ç­†è¨˜
                                    </span>
                                </p>
                            </div>
                        </div>
                    </section>

                    <!-- Markdown èªæ³• -->
                    <section>
                        <h3 class="text-xl font-bold text-pink-400 mb-3">ğŸ“ Markdown èªæ³•åƒè€ƒ</h3>
                        <div class="bg-gray-900 p-4 rounded-lg text-sm space-y-3 font-mono text-gray-300">
                            <div>
                                <p class="text-blue-400 mb-1">æ¨™é¡Œï¼š</p>
                                <p># æ¨™é¡Œ 1  ## æ¨™é¡Œ 2  ### æ¨™é¡Œ 3</p>
                            </div>
                            <div>
                                <p class="text-blue-400 mb-1">æ–‡å­—æ¨£å¼ï¼š</p>
                                <p>**ç²—é«”** *æ–œé«”* ~~åˆªé™¤ç·š~~</p>
                            </div>
                            <div>
                                <p class="text-blue-400 mb-1">åˆ—è¡¨ï¼š</p>
                                <p>- é …ç›®åˆ—è¡¨</p>
                                <p>1. ç·¨è™Ÿåˆ—è¡¨</p>
                                <p>- [ ] ä»»å‹™åˆ—è¡¨ï¼ˆæœªå®Œæˆï¼‰</p>
                                <p>- [x] ä»»å‹™åˆ—è¡¨ï¼ˆå·²å®Œæˆï¼‰</p>
                            </div>
                            <div>
                                <p class="text-blue-400 mb-1">é€£çµèˆ‡åœ–ç‰‡ï¼š</p>
                                <p>[é€£çµæ–‡å­—](https://example.com)</p>
                                <p>![åœ–ç‰‡æè¿°](åœ–ç‰‡ç¶²å€)</p>
                            </div>
                            <div>
                                <p class="text-blue-400 mb-1">ç¨‹å¼ç¢¼ï¼š</p>
                                <p>`è¡Œå…§ç¨‹å¼ç¢¼`</p>
                                <p>```javascript<br>// ç¨‹å¼ç¢¼å€å¡Šï¼ˆæ”¯æ´èªæ³•é«˜äº®ï¼‰<br>console.log('Hello');<br>```</p>
                            </div>
                            <div>
                                <p class="text-blue-400 mb-1">å¼•ç”¨èˆ‡åˆ†éš”ç·šï¼š</p>
                                <p>&gt; å¼•ç”¨æ–‡å­—</p>
                                <p>---</p>
                            </div>
                            <div>
                                <p class="text-blue-400 mb-1">è¡¨æ ¼ï¼š</p>
                                <p>| æ¬„ä½1 | æ¬„ä½2 |</p>
                                <p>|-------|-------|</p>
                                <p>| å…§å®¹1 | å…§å®¹2 |</p>
                            </div>
                        </div>
                    </section>

                    <!-- å¿«æ·æç¤º -->
                    <section>
                        <h3 class="text-xl font-bold text-cyan-400 mb-3">ğŸ’¡ ä½¿ç”¨æç¤º</h3>
                        <ul class="list-disc list-inside space-y-2 text-gray-300">
                            <li>æ‰€æœ‰è³‡æ–™å„²å­˜åœ¨ç€è¦½å™¨æœ¬åœ°ï¼ˆlocalStorageï¼‰ï¼Œä¸æœƒä¸Šå‚³åˆ°ç¶²è·¯</li>
                            <li>å»ºè­°å®šæœŸä½¿ç”¨ã€ŒåŒ¯å‡ºã€åŠŸèƒ½å‚™ä»½é‡è¦ç­†è¨˜</li>
                            <li>æ¸…é™¤ç€è¦½å™¨è³‡æ–™æœƒå°è‡´ç­†è¨˜éºå¤±ï¼Œè«‹å‹™å¿…å…ˆå‚™ä»½</li>
                            <li>ç­†è¨˜æŒ‰æœ€å¾Œæ›´æ–°æ™‚é–“æ’åºï¼Œæœ€æ–°çš„åœ¨æœ€ä¸Šæ–¹</li>
                            <li>ç·¨è¼¯æ™‚æœƒåœ¨ 1.5 ç§’å¾Œè‡ªå‹•å„²å­˜ï¼Œé¿å…è³‡æ–™éºå¤±</li>
                        </ul>
                    </section>

                    <!-- æŠ€è¡“è³‡è¨Š -->
                    <section class="border-t border-gray-700 pt-4">
                        <h3 class="text-lg font-bold text-gray-400 mb-2">ğŸ”§ æŠ€è¡“è³‡è¨Š</h3>
                        <p class="text-gray-400 text-sm">
                            æœ¬æ‡‰ç”¨ä½¿ç”¨ Tailwind CSSã€marked.jsï¼ˆMarkdown æ¸²æŸ“ï¼‰ã€highlight.jsï¼ˆç¨‹å¼ç¢¼èªæ³•é«˜äº®ï¼‰ã€DOMPurifyï¼ˆå®‰å…¨é˜²è­·ï¼‰é–‹ç™¼ã€‚<br>
                            ç´”å‰ç«¯æ‡‰ç”¨ï¼Œç„¡éœ€ä¼ºæœå™¨ï¼Œå¯é›¢ç·šä½¿ç”¨ã€‚
                        </p>
                    </section>
                </div>

                <!-- Modal Footer -->
                <div class="sticky bottom-0 bg-gray-800 border-t border-gray-700 p-4 flex justify-end">
                    <button id="closeHelpBtn2" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded-lg font-semibold">
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('Script started');

        // Configure marked.js for full GFM support
        marked.setOptions({
            gfm: true,              // GitHub Flavored Markdown
            breaks: true,           // Convert \n to <br>
            pedantic: false,
            sanitize: false,        // We use DOMPurify instead
            smartLists: true,
            smartypants: false,
            highlight: function(code, lang) {
                // Use highlight.js for syntax highlighting
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (err) {
                        console.error('Highlight error:', err);
                    }
                }
                return code;
            }
        });

        // State
        let notes = [];
        let currentNoteId = null;
        let autoSaveTimeout = null;
        let isEditMode = true; // true: ç¼–è¾‘æ¨¡å¼, false: é¢„è§ˆæ¨¡å¼
        let searchQuery = ''; // æœç´¢å…³é”®å­—

        // Elements
        const els = {
            newNoteBtn: document.getElementById('newNoteBtn'),
            noteList: document.getElementById('noteList'),
            noteTitle: document.getElementById('noteTitle'),
            noteContent: document.getElementById('noteContent'),
            markdownPreview: document.getElementById('markdownPreview'),
            deleteNoteBtn: document.getElementById('deleteNoteBtn'),
            saveStatus: document.getElementById('saveStatus'),
            toggleModeBtn: document.getElementById('toggleModeBtn'),
            editorSection: document.getElementById('editorSection'),
            previewSection: document.getElementById('previewSection'),
            searchInput: document.getElementById('searchInput'),
            clearSearchBtn: document.getElementById('clearSearchBtn'),
            searchStats: document.getElementById('searchStats'),
            searchCount: document.getElementById('searchCount'),
            noteTimestamp: document.getElementById('noteTimestamp'),
            createdTime: document.getElementById('createdTime'),
            updatedTime: document.getElementById('updatedTime'),
            exportBtn: document.getElementById('exportBtn'),
            importBtn: document.getElementById('importBtn'),
            importFileInput: document.getElementById('importFileInput'),
            helpBtn: document.getElementById('helpBtn'),
            helpModal: document.getElementById('helpModal'),
            closeHelpBtn: document.getElementById('closeHelpBtn'),
            closeHelpBtn2: document.getElementById('closeHelpBtn2')
        };

        // Notes
        function loadNotes() {
            const saved = localStorage.getItem('demo-notes');
            notes = saved ? JSON.parse(saved) : [];
            notes.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
            renderNoteList();
        }

        function saveNotes() {
            localStorage.setItem('demo-notes', JSON.stringify(notes));
        }

        function renderNoteList() {
            // æœç´¢è¿‡æ»¤
            let filteredNotes = notes;
            if (searchQuery.trim()) {
                const query = searchQuery.toLowerCase();
                filteredNotes = notes.filter(note => {
                    const title = (note.title || '').toLowerCase();
                    const content = (note.content || '').toLowerCase();
                    return title.includes(query) || content.includes(query);
                });

                // æ˜¾ç¤ºæœç´¢ç»Ÿè®¡
                els.searchStats.classList.remove('hidden');
                els.searchCount.textContent = filteredNotes.length;
            } else {
                // éšè—æœç´¢ç»Ÿè®¡
                els.searchStats.classList.add('hidden');
            }

            if (notes.length === 0) {
                els.noteList.innerHTML = '<div class="p-4 text-center text-gray-400"><p>å°šç„¡ç­†è¨˜</p></div>';
                return;
            }

            if (filteredNotes.length === 0) {
                els.noteList.innerHTML = '<div class="p-4 text-center text-gray-400"><p>æ‰¾ä¸åˆ°ç¬¦åˆçš„ç­†è¨˜</p><p class="text-xs mt-2">è©¦è©¦å…¶ä»–é—œéµå­—</p></div>';
                return;
            }

            els.noteList.innerHTML = filteredNotes.map(note => {
                const active = note.id === currentNoteId ? 'active' : '';
                const title = highlightText(note.title || 'ç„¡æ¨™é¡Œ', searchQuery);
                const preview = highlightText((note.content || '').substring(0, 50), searchQuery);
                const timeText = formatRelativeTime(note.updatedAt);

                return `
                    <div class="note-list-item p-4 cursor-pointer border-b border-gray-700 ${active}" onclick="selectNote('${note.id}')">
                        <h3 class="font-semibold text-gray-200 truncate">${title}</h3>
                        <p class="text-sm text-gray-400 mt-1 truncate">${preview}</p>
                        <p class="text-xs text-gray-500 mt-1">ğŸ“… ${timeText}</p>
                    </div>
                `;
            }).join('');
        }

        function highlightText(text, query) {
            if (!query.trim()) {
                return escapeHtml(text);
            }

            const escaped = escapeHtml(text);
            const escapedQuery = escapeHtml(query);
            const regex = new RegExp(`(${escapedQuery})`, 'gi');
            return escaped.replace(regex, '<mark class="bg-yellow-500 text-gray-900 px-1 rounded">$1</mark>');
        }

        function performSearch(query) {
            searchQuery = query;
            renderNoteList();

            // æ˜¾ç¤º/éšè—æ¸…é™¤æŒ‰é’®
            if (query.trim()) {
                els.clearSearchBtn.classList.remove('hidden');
            } else {
                els.clearSearchBtn.classList.add('hidden');
            }
        }

        function clearSearch() {
            els.searchInput.value = '';
            performSearch('');
            els.searchInput.focus();
        }

        function createNote() {
            console.log('Creating note...');
            const note = {
                id: Date.now().toString(36),
                title: 'æ–°ç­†è¨˜',
                content: '',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            notes.unshift(note);
            saveNotes();
            renderNoteList();

            // æ–°å»ºç¬”è®°æ—¶ç›´æ¥è¿›å…¥ç¼–è¾‘æ¨¡å¼
            currentNoteId = note.id;
            els.noteTitle.value = note.title;
            els.noteContent.value = note.content;
            els.deleteNoteBtn.disabled = false;
            els.toggleModeBtn.disabled = false;
            setEditMode(true);
            renderMarkdown(note.content);
            updateTimestampDisplay(note);
            renderNoteList();
        }

        function selectNote(id) {
            console.log('Selecting note:', id);
            const note = notes.find(n => n.id === id);
            if (!note) return;

            currentNoteId = id;
            els.noteTitle.value = note.title;
            els.noteContent.value = note.content;
            els.deleteNoteBtn.disabled = false;
            els.toggleModeBtn.disabled = false;

            // é»˜è®¤è¿›å…¥é¢„è§ˆæ¨¡å¼ï¼ˆMarkdown æ¸²æŸ“æ¨¡å¼ï¼‰
            setEditMode(false);

            renderMarkdown(note.content);
            updateTimestampDisplay(note);
            renderNoteList();
        }

        function setEditMode(editMode) {
            isEditMode = editMode;

            if (isEditMode) {
                // ç¼–è¾‘æ¨¡å¼ï¼šæ˜¾ç¤ºç¼–è¾‘å™¨å’ŒMarkdowné¢„è§ˆ
                els.editorSection.classList.remove('hidden');
                els.previewSection.classList.remove('hidden');
                els.noteTitle.disabled = false;
                els.noteContent.disabled = false;
                els.toggleModeBtn.innerHTML = 'âœ… å®Œæˆ';
                els.toggleModeBtn.className = 'bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg';
                els.saveStatus.textContent = 'ç·¨è¼¯æ¨¡å¼';
            } else {
                // Markdown é¢„è§ˆæ¨¡å¼ï¼šåªæ˜¾ç¤ºæ¸²æŸ“ç»“æœ
                els.editorSection.classList.add('hidden');
                els.previewSection.classList.remove('hidden');
                els.noteTitle.disabled = true;
                els.noteContent.disabled = true;
                els.toggleModeBtn.innerHTML = 'âœï¸ ç·¨è¼¯';
                els.toggleModeBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg';
                els.saveStatus.textContent = 'Markdown æ¨¡å¼';
            }
        }

        function toggleMode() {
            if (!currentNoteId) return;
            setEditMode(!isEditMode);
        }

        function updateNote(data) {
            const note = notes.find(n => n.id === currentNoteId);
            if (!note) return;

            Object.assign(note, data, { updatedAt: new Date().toISOString() });
            notes.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
            saveNotes();
            renderNoteList();
            updateTimestampDisplay(note);

            // æ˜¾ç¤ºä¿å­˜çŠ¶æ€
            const originalStatus = els.saveStatus.textContent;
            els.saveStatus.textContent = 'å·²å„²å­˜ âœ“';
            setTimeout(() => {
                els.saveStatus.textContent = isEditMode ? 'ç·¨è¼¯æ¨¡å¼' : 'Markdown æ¨¡å¼';
            }, 2000);
        }

        function deleteNote() {
            if (!currentNoteId || !confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç­†è¨˜å—ï¼Ÿ')) return;

            notes = notes.filter(n => n.id !== currentNoteId);
            saveNotes();

            currentNoteId = null;
            els.noteTitle.value = '';
            els.noteContent.value = '';
            els.noteTitle.disabled = true;
            els.noteContent.disabled = true;
            els.deleteNoteBtn.disabled = true;
            els.toggleModeBtn.disabled = true;
            els.saveStatus.textContent = 'è«‹é¸æ“‡æˆ–å»ºç«‹ç­†è¨˜';
            els.markdownPreview.innerHTML = '<p class="text-gray-500">Markdown æ¸²æŸ“å€åŸŸ</p>';
            updateTimestampDisplay(null);

            renderNoteList();
        }

        function renderMarkdown(text) {
            try {
                const html = DOMPurify.sanitize(marked.parse(text || ''));
                els.markdownPreview.innerHTML = html || '<p class="text-gray-500">é è¦½å€åŸŸ</p>';
            } catch (e) {
                console.error('Markdown error:', e);
            }
        }

        function debounce(fn, delay) {
            return (...args) => {
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(() => fn(...args), delay);
            };
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDateTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        function formatRelativeTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'å‰›å‰›';
            if (diffMins < 60) return `${diffMins} åˆ†é˜å‰`;
            if (diffHours < 24) return `${diffHours} å°æ™‚å‰`;
            if (diffDays < 7) return `${diffDays} å¤©å‰`;

            return formatDateTime(isoString);
        }

        function updateTimestampDisplay(note) {
            if (!note) {
                els.noteTimestamp.classList.add('hidden');
                return;
            }

            els.createdTime.textContent = `å»ºç«‹æ™‚é–“ï¼š${formatDateTime(note.createdAt)}`;
            els.updatedTime.textContent = `æœ€å¾Œæ›´æ–°ï¼š${formatDateTime(note.updatedAt)}`;
            els.noteTimestamp.classList.remove('hidden');
        }

        // Export/Import Functions
        function exportData() {
            try {
                // è·å–æ‰€æœ‰ç¬”è®°æ•°æ®
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    notesCount: notes.length,
                    notes: notes
                };

                // è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²
                const jsonString = JSON.stringify(exportData, null, 2);

                // åˆ›å»º Blob å¯¹è±¡
                const blob = new Blob([jsonString], { type: 'application/json' });

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;

                // ç”Ÿæˆæ–‡ä»¶åï¼ˆåŒ…å«æ—¥æœŸæ—¶é—´ï¼‰
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-');
                a.download = `markdown-notes-backup-${dateStr}-${timeStr}.json`;

                // è§¦å‘ä¸‹è½½
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                const originalStatus = els.saveStatus.textContent;
                els.saveStatus.textContent = `âœ… å·²åŒ¯å‡º ${notes.length} ç­†ç­†è¨˜`;
                setTimeout(() => {
                    els.saveStatus.textContent = originalStatus;
                }, 3000);

                console.log('Data exported successfully:', exportData);
            } catch (error) {
                console.error('Export error:', error);
                alert('åŒ¯å‡ºå¤±æ•—ï¼š' + error.message);
            }
        }

        function importData() {
            // è§¦å‘æ–‡ä»¶é€‰æ‹©
            els.importFileInput.click();
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!file.name.endsWith('.json')) {
                alert('è«‹é¸æ“‡ JSON æ ¼å¼çš„æª”æ¡ˆ');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);

                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (!importedData.notes || !Array.isArray(importedData.notes)) {
                        throw new Error('ç„¡æ•ˆçš„è³‡æ–™æ ¼å¼ï¼šæ‰¾ä¸åˆ° notes é™£åˆ—');
                    }

                    // è¯¢é—®ç”¨æˆ·å¯¼å…¥æ–¹å¼
                    const choice = confirm(
                        `å³å°‡åŒ¯å…¥ ${importedData.notesCount || importedData.notes.length} ç­†ç­†è¨˜\n\n` +
                        `åŒ¯å‡ºæ—¥æœŸï¼š${importedData.exportDate ? new Date(importedData.exportDate).toLocaleString('zh-TW') : 'æœªçŸ¥'}\n\n` +
                        `é»æ“Šã€Œç¢ºå®šã€å°‡è¦†è“‹ç¾æœ‰è³‡æ–™\n` +
                        `é»æ“Šã€Œå–æ¶ˆã€å°‡åˆä½µè³‡æ–™ï¼ˆä¿ç•™ç¾æœ‰ç­†è¨˜ï¼‰`
                    );

                    let finalNotes = [];
                    let importedCount = 0;

                    if (choice) {
                        // è¦†ç›–æ¨¡å¼ï¼šæ›¿æ¢æ‰€æœ‰æ•°æ®
                        finalNotes = importedData.notes;
                        importedCount = finalNotes.length;
                    } else {
                        // åˆå¹¶æ¨¡å¼ï¼šä¿ç•™ç°æœ‰æ•°æ®ï¼Œæ·»åŠ æ–°æ•°æ®
                        const existingIds = new Set(notes.map(n => n.id));
                        const newNotes = importedData.notes.filter(note => !existingIds.has(note.id));
                        finalNotes = [...notes, ...newNotes];
                        importedCount = newNotes.length;
                    }

                    // æ›´æ–° notes æ•°ç»„
                    notes = finalNotes;

                    // æ’åºå¹¶ä¿å­˜
                    notes.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                    saveNotes();
                    renderNoteList();

                    // æ¸…é™¤å½“å‰ç¼–è¾‘
                    if (currentNoteId && !notes.find(n => n.id === currentNoteId)) {
                        currentNoteId = null;
                        els.noteTitle.value = '';
                        els.noteContent.value = '';
                        els.noteTitle.disabled = true;
                        els.noteContent.disabled = true;
                        els.deleteNoteBtn.disabled = true;
                        els.toggleModeBtn.disabled = true;
                        els.markdownPreview.innerHTML = '<p class="text-gray-500">Markdown æ¸²æŸ“å€åŸŸ</p>';
                        updateTimestampDisplay(null);
                    }

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    const mode = choice ? 'è¦†è“‹' : 'åˆä½µ';
                    els.saveStatus.textContent = `âœ… å·²${mode}åŒ¯å…¥ ${importedCount} ç­†ç­†è¨˜`;
                    setTimeout(() => {
                        els.saveStatus.textContent = 'è«‹é¸æ“‡æˆ–å»ºç«‹ç­†è¨˜';
                    }, 3000);

                    console.log(`Data imported successfully (${mode} mode):`, { importedCount, totalNotes: notes.length });

                } catch (error) {
                    console.error('Import error:', error);
                    alert('åŒ¯å…¥å¤±æ•—ï¼š' + error.message);
                }

                // é‡ç½®æ–‡ä»¶è¾“å…¥
                event.target.value = '';
            };

            reader.onerror = () => {
                alert('è®€å–æª”æ¡ˆå¤±æ•—');
                event.target.value = '';
            };

            reader.readAsText(file);
        }

        // Help Modal Functions
        function openHelpModal() {
            els.helpModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
        }

        function closeHelpModal() {
            els.helpModal.classList.add('hidden');
            document.body.style.overflow = ''; // æ¢å¤æ»šåŠ¨
        }

        // Make selectNote global
        window.selectNote = selectNote;

        // Event listeners
        els.newNoteBtn.addEventListener('click', createNote);
        els.deleteNoteBtn.addEventListener('click', deleteNote);
        els.toggleModeBtn.addEventListener('click', toggleMode);

        // Export/Import events
        els.exportBtn.addEventListener('click', exportData);
        els.importBtn.addEventListener('click', importData);
        els.importFileInput.addEventListener('change', handleImportFile);

        // Help Modal events
        els.helpBtn.addEventListener('click', openHelpModal);
        els.closeHelpBtn.addEventListener('click', closeHelpModal);
        els.closeHelpBtn2.addEventListener('click', closeHelpModal);

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        els.helpModal.addEventListener('click', (e) => {
            if (e.target === els.helpModal) {
                closeHelpModal();
            }
        });

        // ESC é”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !els.helpModal.classList.contains('hidden')) {
                closeHelpModal();
            }
        });

        // Search events
        els.searchInput.addEventListener('input', (e) => {
            performSearch(e.target.value);
        });

        els.clearSearchBtn.addEventListener('click', clearSearch);

        // Enter key to search
        els.searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                clearSearch();
            }
        });

        const debouncedSave = debounce((data) => updateNote(data), 1500);

        els.noteTitle.addEventListener('input', (e) => {
            debouncedSave({ title: e.target.value });
            renderNoteList();
        });

        els.noteContent.addEventListener('input', (e) => {
            debouncedSave({ content: e.target.value });
            renderMarkdown(e.target.value);
        });

        // Initialize
        loadNotes();
        console.log('App ready!');
    </script>
</body>
</html>
